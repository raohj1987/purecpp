<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title x-text="pageTitle">加载中...</title>

    <link rel="stylesheet" href="css/pico.min.css">
    <link rel="stylesheet" href="font-awesome/css/all.min.css">
    <link rel="stylesheet" href="css/simplemde.min.css">
    <link rel="stylesheet" href="css/atom-one-dark.min.css">
    <!-- PureCpp 统一样式 -->
    <link rel="stylesheet" href="css/purecpp.css">

    <script src="script/simplemde.min.js"></script>
    <script src="script/highlight.min.js"></script>
    <script src="script/cpp.min.js"></script>
    <script src="script/marked.min.js"></script>
    <script defer src="script/alpine.js"></script>

    <style>
        /* 代码块样式（个性化） */
        .article-content pre {
            background: var(--code-background) !important;
            border: 1px solid var(--code-border) !important;
            padding: 1rem !important;
            border-radius: 8px !important;
            overflow-x: auto !important;
            margin: 1rem 0 !important;
        }

        .article-content code {
            font-family: Consolas, 'Fira Code', monospace !important;
            font-size: 0.95rem !important;
        }

        .article-content blockquote {
            border-left: 4px solid var(--primary);
            padding-left: 1rem;
            color: var(--muted-color);
            margin: 1rem 0;
            background: #f9fafb !important;
            padding: 1rem !important;
            border-radius: 4px !important;
        }

        /* 自定义下拉样式（个性化） */
        .dropdown {
            position: relative;
            display: inline-block;
            width: 600px;
        }

        .search-box {
            margin-bottom: 0.5rem;
        }
    </style>
</head>

<body>
    <!-- 统一页头占位符 -->
    <div id="header-container"></div>

    <main class="page-wrapper" x-data="articleDetailComponent()" x-init="init()">
        <div x-show="isLoading" class="text-center py-4">
            <i class="fas fa-circle-o-notch fa-spin"></i> 正在加载文章...
        </div>

        <div x-show="errorMessage" class="alert alert-danger" role="alert" x-text="errorMessage"></div>

        <!-- 加精华图标：仅管理员可见 -->
        <div x-show="currentUser && (currentUser.role === 'admin' || currentUser.role === 'superadmin') && !isLoading && !errorMessage && article.title"
             @click="toggleFeatured()"
             style="position: fixed; right: 50px; top: 50%; transform: translateY(-50%); cursor: pointer; z-index: 1000; margin: 0; padding: 0; border: none; background: transparent; overflow: visible;">
            <img :src="article.tag_ids.includes('108') ? 'images/recommend.png' : 'images/recommend.png'"
                 :style="article.tag_ids.includes('108') ? 'width: 64px; height: 64px; opacity: 1; display: block; background: transparent;' : 'width: 64px; height: 64px; opacity: 0.6; display: block; background: transparent;'"
                 :title="article.tag_ids.includes('108') ? '取消精华' : '加精华'"
                 style="margin: 0; padding: 0; border: none; background: transparent; box-shadow: none;">
        </div>

        <article x-show="!isLoading && !errorMessage && article.title" class="card">
            <div class="card-body">
                <h1 class="article-title" style="display: flex; align-items: center; justify-content: space-between;">
                    <span x-text="article.title"></span>
                </h1>

                <div class="article-meta">
                    <span><i class="fas fa-user"></i> <span x-text="article.author_name"></span></span>
                    <span><i class="fas fa-tag"></i> 
                        <template x-if="article.tag_ids && article.tag_ids.includes('|')">
                            <template x-for="tagId in article.tag_ids.split('|')" :key="tagId">
                                <template x-if="getTagName(tagId)">
                                    <span class="tag" style="margin-right: 5px;" x-text="getTagName(tagId)"></span>
                                </template>
                            </template>
                        </template>
                        <template x-else>
                            <span x-text="article.tag_ids ? getTagName(article.tag_ids) : ''"></span>
                        </template>
                    </span>
                    <span><i class="fas fa-calendar"></i> <span x-text="formatDate(article.created_at)"></span></span>
                    <span><i class="fas fa-eye"></i> <span x-text="article.views_count"></span> 浏览</span>

                    <!-- 编辑按钮：仅作者可见 -->
                    <span x-show="currentUser && currentUser.username === article.author_name" @click="startEdit()"
                          style="cursor: pointer; color: #007bff; margin-left: 10px;">
                        <i class="fas fa-edit"></i> 编辑
                    </span>
                </div>

                <div x-show="!isEditing" id="article-content" class="article-content"></div>
                <!-- 编辑模式：复用撰写文章的 textarea 结构 -->
                <div x-show="isEditing" x-cloak style="margin-top: 1rem;">
                    <label>文章摘要</label>
                    <textarea x-model="excerpt" rows="3" style="width: 100%; margin-bottom: 1rem;"></textarea>

                    <label>文章内容 (Markdown)</label>
                    <textarea id="markdown-editor" x-model="content" rows="20"
                              style="width: 100%; font-family: monospace;"></textarea>


                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                        <label for="tag-select" style="margin: 0; white-space: nowrap;">选择标签</label>
                        <!-- 新的多选组件 -->
                        <div class="dropdown" @click.outside="open = false" style="flex: 1;">
                            <!-- 触发按钮 -->
                            <button type="button" @click="open = !open"
                                    style="width: 100%; text-align: left; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--bg-card); color: var(--text-main); padding: 0.5rem 0.8rem; height: 46px; box-sizing: border-box;">
                                <template x-if="selectedTagIds.length === 0"><span style="color: var(--muted-color);">请选择选项</span>
                                </template>
                                <template x-if="selectedTagIds && selectedTagIds.length > 0">
                                    <span x-text="getSelectedTagNames()"></span>
                                </template>
                            </button>
                            <!-- 下拉菜单 -->
                            <div class="dropdown-menu" x-show="open" x-transition style="width: 100%;">
                                <template x-for="tag in tags" :key="tag.tag_id">
                                    <label>
                                        <input type="checkbox" :value="tag.tag_id" @change="toggleTag(tag.tag_id)"
                                               :checked="selectedTagIds && selectedTagIds.some(id => id == tag.tag_id)">
                                        <span x-text="tag.name"></span>
                                    </label>
                                </template>
                            </div>
                        </div>
                    </div>
                    <div style="margin-top: 1rem; display: flex; justify-content: center; gap: 1rem;">
                        <button @click="saveChanges()" class="primary">保存修改</button>
                        <button @click="cancelEdit()" class="secondary">取消</button>
                    </div>
                </div>
            </div>
            <div class="comments-section"
                 style="margin-top: 2rem; border-top: 1px solid var(--border-color); padding-top: 1rem;">
                <h2>评论 (<span x-text="article.comments_count"></span>)</h2>

                <!-- 评论表单 -->
                <div class="comment-form" x-show="currentUser"
                     style="margin-bottom: 2rem; padding: 1rem; border: 1px solid var(--border-color); border-radius: 8px;">
                    <h3>发表评论</h3>
                    <textarea x-model="newCommentContent" rows="4" placeholder="写下你的评论..."
                              style="width: 100%; margin-bottom: 1rem; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px;"></textarea>
                    <div style="display: flex; justify-content: flex-end;">
                        <button @click="submitComment" :disabled="!newCommentContent.trim()"
                                style="padding: 0.5rem 1rem; background-color: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer;">
                            提交评论
                        </button>
                    </div>
                </div>

                <!-- 未登录提示 -->
                <div x-show="!currentUser"
                     style="margin-bottom: 2rem; padding: 1rem; background-color: #f8f9fa; border-radius: 8px;">
                    <p>请<a href="/login.html">登录</a>后发表评论</p>
                </div>

                <!-- 评论列表 -->
                <div class="comments-list" style="margin-top: 1rem;">
                    <template
                            x-for="comment in comments.filter(c => c.parent_comment_id === 0).sort((a, b) => b.created_at - a.created_at)"
                            :key="comment.comment_id">
                        <div class="comment-item"
                             style="margin-bottom: 1rem; padding: 1rem; border: 1px solid var(--border-color); border-radius: 8px;">
                            <div class="comment-header"
                                 style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <span class="comment-author" style="font-weight: bold; color: var(--primary);"
                                      x-text="comment.author_name"></span>
                            </div>
                            <div class="comment-content" style="margin-bottom: 0.5rem; line-height: 1.5;"
                                 x-html="comment.content"></div>
                            <div class="comment-footer"
                                 style="display: flex; justify-content: space-between; align-items: center; font-size: 0.75rem;">
                                <div style="display: flex; gap: 1rem; font-size: 0.8rem; color: var(--muted-color);">
                                    <span class="comment-time" x-text="formatDate(comment.created_at)"></span>
                                    <span class="comment-ip" x-text="comment.ip || ''"></span>
                                </div>
                                <div class="comment-actions" style="font-size: 0.8rem; margin-left: 0.5rem;">
                                    <button @click="replyToComment(comment.comment_id)"
                                            style="background: none; border: none; color: var(--primary); cursor: pointer; padding: 0; margin-right: 1rem;">
                                        回复
                                    </button>
                                </div>
                            </div>


                            <!-- 回复表单 -->
                            <div class="reply-form" x-show="replyTo === comment.comment_id">
                                <textarea x-model="replyContent" rows="3" placeholder="回复评论..."></textarea>
                                <div class="reply-form-actions">
                                    <button @click="cancelReply" class="reply-form-cancel">取消</button>
                                    <button @click="submitReply(comment.comment_id)" :disabled="!replyContent.trim()"
                                            class="reply-form-submit">回复
                                    </button>
                                </div>
                            </div>

                            <!-- 子评论 -->
                            <div class="child-comments"
                                 style="margin-left: 2rem; margin-top: 1rem; border-left: 2px solid var(--border-color); padding-left: 1rem;">
                                <template x-for="child in getChildComments(comment.comment_id)" :key="child.comment_id">
                                    <div class="child-comment-item"
                                         style="margin-bottom: 0.75rem; padding: 0.75rem; background-color: #f8f9fa; border-radius: 4px;">
                                        <!-- 回复标题：xx回复xx -->
                                        <div class="reply-title"
                                             style="font-size: 0.75rem; color: var(--muted-color); margin-bottom: 0.3rem;">
                                            <span x-text="child.author_name"></span> 回复 <span
                                                x-text="child.parent_user_name"></span>
                                        </div>

                                        <div class="comment-content"
                                             style="margin-bottom: 0.3rem; line-height: 1.4; font-size: 0.9rem;"
                                             x-html="child.content"></div>

                                        <div class="comment-footer"
                                             style="display: flex; justify-content: space-between; align-items: center; font-size: 0.75rem;">
                                            <div style="display: flex; gap: 0.75rem; color: var(--muted-color);">
                                                <span class="comment-time" x-text="formatDate(child.created_at)"></span>
                                                <span class="comment-ip" x-text="child.ip || ''"></span>
                                            </div>
                                            <button @click="replyToComment(child.comment_id)"
                                                    style="background: none; border: none; color: var(--primary); cursor: pointer; padding: 0;">
                                                回复
                                            </button>
                                        </div>

                                        <!-- 子评论的回复表单 -->
                                        <div class="reply-form" x-show="replyTo === child.comment_id">
                                            <textarea x-model="replyContent" rows="2"
                                                      placeholder="回复评论..."></textarea>
                                            <div class="reply-form-actions">
                                                <button @click="cancelReply" class="reply-form-cancel">取消</button>
                                                <button @click="submitReply(child.comment_id)"
                                                        :disabled="!replyContent.trim()"
                                                        class="reply-form-submit">回复
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>

                    <!-- 暂无评论 -->
                    <div x-show="comments.length === 0"
                         style="text-align: center; padding: 2rem; color: var(--muted-color);">
                        <p>暂无评论，快来发表第一条评论吧！</p>
                    </div>
                </div>
            </div>
        </article>
    </main>

    <!-- 统一页脚占位符 -->
    <div id="footer-container"></div>
    <!-- API服务脚本 -->
    <script src="script/api_service.js"></script>
    <!-- 统一布局脚本（包含用户信息管理功能） -->
    <script src="script/layout.js"></script>

    <script>
        marked.setOptions({
            gfm: true,
            breaks: true,
            sanitize: false,
            highlight: (code, lang) => {
                const language = hljs.getLanguage(lang) ? lang : 'plaintext';
                return hljs.highlight(code, { language }).value;
            },
            langPrefix: 'hljs language-'
        });

        hljs.configure({ ignoreUnescapedHTML: true, languages: ['cpp', 'c'] });

        // 用户资料弹窗功能
        (function () {
            // 创建全局弹窗容器
            const popupContainer = document.createElement('div');
            popupContainer.className = 'user-profile-popup';
            popupContainer.style.display = 'none';
            popupContainer.style.position = 'fixed';
            document.body.appendChild(popupContainer);

            let currentUsername = null;
            let timer = null;

            // 格式化日期
            function formatDate(timestamp) {
                const date = new Date(timestamp);
                return date.toLocaleDateString('zh-CN', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            }

            // 显示用户资料弹窗
            async function showUserProfilePopup(username, x, y) {
                if (currentUsername === username) {
                    return;
                }

                currentUsername = username;
                popupContainer.innerHTML = '<div class="loading">加载中...</div>';
                popupContainer.style.display = 'block';
                popupContainer.style.left = `${x}px`;
                popupContainer.style.top = `${y}px`;

                try {
                    const response = await apiService.getUserProfile(username);
                    if (response.success && response.data) {
                        const user = response.data;
                        const levelText = apiService.getLevelText(user.level);

                        // 构建弹窗内容
                        popupContainer.innerHTML = `
                            <div class="popup-header">
                                <img src="${user.avatar}"
                                     alt="${user.username}" class="avatar">
                                <div class="user-info">
                                    <h4>${user.username}</h4>
                                    <p>${user.title || '用户'}</p>
                                </div>
                            </div>
                            ${user.bio ? `<div class="user-bio">${user.bio}</div>` : ''}
                            <div class="user-details">
                                <div class="detail-item">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <span>${user.location || '未知'}</span>
                                </div>
                                <div class="detail-item">
                                    <i class="fas fa-star"></i>
                                    <span>${levelText}</span>
                                </div>
                                <div class="detail-item">
                                    <i class="fas fa-calendar"></i>
                                    <span>注册于 ${formatDate(user.created_at)}</span>
                                </div>
                                ${user.skills ? `
                                <div class="detail-item">
                                    <i class="fas fa-tags"></i>
                                    <span>${user.skills}</span>
                                </div>
                                ` : ''}
                                <div class="detail-item">
                                    <i class="fas fa-circle"></i>
                                    <span>${user.status}</span>
                                </div>
                            </div>
                        `;
                    }
                } catch (error) {
                    console.error('获取用户资料失败:', error);
                    popupContainer.innerHTML = '<div class="loading">获取用户资料失败</div>';
                }
            }

            // 隐藏用户资料弹窗
            function hideUserProfilePopup() {
                currentUsername = null;
                popupContainer.style.display = 'none';
            }

            // 为所有用户名添加悬停事件
            function initUserProfileHover() {
                // 在Alpine.js渲染完成后执行
                setTimeout(() => {
                    // 为article.html中的用户名添加悬停事件

                    // 1. 文章作者用户名
                    const articleAuthor = document.querySelector('.article-meta span:first-child span');
                    if (articleAuthor) {
                        articleAuthor.className = 'username-hover';
                        articleAuthor.addEventListener('mouseenter', function (e) {
                            const username = this.textContent.trim();
                            const rect = this.getBoundingClientRect();
                            const x = rect.left + window.pageXOffset;
                            const y = rect.bottom + window.pageYOffset + 5;

                            timer = setTimeout(() => {
                                showUserProfilePopup(username, x, y);
                            }, 300);
                        });

                        articleAuthor.addEventListener('mouseleave', function () {
                            clearTimeout(timer);
                        });
                    }

                    // 2. 评论作者用户名
                    document.querySelectorAll('.comment-author').forEach(usernameElement => {
                        usernameElement.className = 'username-hover';
                        usernameElement.addEventListener('mouseenter', function (e) {
                            const username = this.textContent.trim();
                            const rect = this.getBoundingClientRect();
                            const x = rect.left + window.pageXOffset;
                            const y = rect.bottom + window.pageYOffset + 5;

                            timer = setTimeout(() => {
                                showUserProfilePopup(username, x, y);
                            }, 300);
                        });

                        usernameElement.addEventListener('mouseleave', function () {
                            clearTimeout(timer);
                        });
                    });
                }, 500);
            }

            // 初始化用户资料悬停功能
            document.addEventListener('DOMContentLoaded', initUserProfileHover);

            // 点击页面其他地方关闭弹窗
            document.addEventListener('click', function (e) {
                if (!e.target.closest('.username-hover') && !e.target.closest('.user-profile-popup')) {
                    hideUserProfilePopup();
                }
            });

            // 监听Alpine.js的更新事件，重新初始化悬停事件
            document.addEventListener('alpine:init', initUserProfileHover);
        })();

        function articleDetailComponent() {
            return {
                article: {},
                isLoading: true,
                errorMessage: '',
                currentUser: null,
                isEditing: false,
                tags: [],
                selectedTagIds: [],
                open: false,
                simplemde: null,
                slug: '',
                title: '',
                excerpt: '',
                content: '',
                // 评论相关数据
                comments: [],
                newCommentContent: '',
                replyTo: null,
                replyContent: '',

                get pageTitle() {
                    return this.article.title ? `${this.article.title} - PureCpp社区` : '文章详情 - PureCpp社区';
                },

                formatDate(timestamp) {
                    if (!timestamp) return '';

                    const commentDate = new Date(timestamp);
                    const now = new Date();
                    const diffMs = now - commentDate;
                    const diffMinutes = Math.floor(diffMs / (1000 * 60));
                    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

                    // 半小时以内显示“刚刚”
                    if (diffMinutes < 30) {
                        return '刚刚';
                    }

                    if (diffMinutes < 60) {
                        return `半小时以前`;
                    }

                    // 12小时以内显示“几小时以前”
                    if (diffHours < 12) {
                        return `${diffHours}小时以前`;
                    }

                    // 3天以内显示“几天前”
                    if (diffDays < 3) {
                        return `${diffDays}天前`;
                    }

                    // 超过3天，判断是否在今年内
                    const isSameYear = now.getFullYear() === commentDate.getFullYear();

                    if (isSameYear) {
                        // 今年内显示“几月几号”
                        return commentDate.toLocaleString('zh-CN', {
                            month: 'long',
                            day: 'numeric'
                        });
                    } else {
                        // 今年以前显示“几年几月几日”
                        return commentDate.toLocaleString('zh-CN', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        });
                    }
                },

                // 根据标签ID获取标签名称
                getTagName(tagId) {
                    const tag = this.tags.find(t => t.tag_id == tagId);
                    return tag ? tag.name : '';
                },

                // 新增：修复重复高亮的核心函数
                highlightCodeBlocks() {
                    const codeBlocks = document.querySelectorAll('#article-content pre code');
                    codeBlocks.forEach(block => {
                        // 移除已高亮标记，避免重复警告
                        if (block.dataset.highlighted === 'yes') {
                            delete block.dataset.highlighted;
                        }
                        // 单次高亮当前代码块
                        hljs.highlightElement(block);
                    });
                },

                renderMarkdown(content) {
                    const contentEl = document.getElementById('article-content');
                    if (!contentEl || !content) return;

                    const unescaped = content.replace(/\\n/g, '\n').replace(/\\t/g, '\t');
                    const html = marked.parse(unescaped);

                    contentEl.innerHTML = html;

                    // 替换原有 hljs.highlightAll() 为精准高亮
                    setTimeout(() => this.highlightCodeBlocks(), 50);
                },

                async fetchArticle() {
                    const slug = new URLSearchParams(window.location.search).get('slug');
                    if (!slug) {
                        this.errorMessage = '缺少文章标识符 (slug)';
                        this.isLoading = false;
                        return;
                    }

                    this.slug = slug;

                    // 使用apiService获取用户信息
                    this.currentUser = apiService.getUserInfo();

                    try {
                        // 使用apiService获取文章信息
                        const response = await apiService.getArticle(slug);
                        this.article = response.data;

                        this.renderMarkdown(this.article.content);

                        // 加载评论
                        await this.fetchComments();

                        this.isLoading = false;
                    } catch (e) {
                        this.errorMessage = `加载失败：${e.message}`;
                        this.isLoading = false;
                    }
                },

                async init() {
                    await this.fetchTags();
                    await this.fetchArticle();
                },

                async fetchTags() {
                    try {
                        // 使用apiService获取标签列表
                        const response = await apiService.getTags();
                        this.tags = response.data;
                    } catch (error) {
                        console.error('获取标签失败:', error);
                        this.errorMessage = '无法加载标签数据，请稍后重试。';
                    }
                },

                // 进入编辑状态
                startEdit() {
                    this.isEditing = true;
                    // 将原始数据同步到编辑表单（避免直接修改原文章对象）
                    this.title = this.article.title;
                    this.excerpt = this.article.summary || '';
                    this.content = this.article.content;

                    if (this.article.content) {
                        this.content = this.article.content.replace(/\\n/g, '\n').replace(/\\t/g, '\t');
                    } else {
                        this.content = '';
                    }

                    // 初始化选中的标签
                    if (this.article.tag_ids) {
                        this.selectedTagIds = this.article.tag_ids.split('|');
                    } else {
                        this.selectedTagIds = [];
                    }

                    this.$nextTick(() => {
                        this.initializeSimpleMDE();
                    });
                },

                // 切换标签选择状态
                toggleTag(tag_id) {
                    const index = this.selectedTagIds.indexOf(tag_id);
                    if (index === -1) {
                        this.selectedTagIds.push(tag_id);
                    } else {
                        this.selectedTagIds.splice(index, 1);
                    }
                },

                // 获取选中的标签名称
                getSelectedTagNames() {
                    if (!this.selectedTagIds) {
                        return '';
                    }
                    return this.selectedTagIds.map(tagId => {
                        const tag = this.tags.find(t => t.tag_id == tagId);
                        return tag ? tag.name : tagId;
                    }).join(', ');
                },

                initializeSimpleMDE() {
                    if (this.simplemde) return;
                    // --- 实例化 SimpleMDE ---
                    this.simplemde = new SimpleMDE({
                        element: document.getElementById("markdown-editor"),
                        spellChecker: false,

                        // 覆盖默认的预览渲染函数
                        previewRender: function (plainText, preview) {
                            return marked.parse(plainText);
                        },
                    });

                    // 监听编辑器的 change 事件，同步数据到 Alpine 的 content 变量
                    this.simplemde.codemirror.on("change", () => {
                        this.content = this.simplemde.value();
                    });
                },

                cancelEdit() {
                    this.isEditing = false;
                },

                async saveChanges() {
                    try {
                        // 将选中的标签ID数组转换为以|分隔的字符串
                        const tagIds = this.selectedTagIds.join('|');
                        // 使用apiService保存文章修改
                        const response = await apiService.editArticle(
                            this.slug,
                            this.title,
                            this.excerpt,
                            this.content,
                            tagIds,
                            this.currentUser.username
                        );

                        // 更新本地显示
                        this.article.title = this.title;
                        this.article.content = this.content;
                        this.article.summary = this.excerpt;
                        this.renderMarkdown(this.article.content);
                        this.isEditing = false;
                        await showAlert('修改成功！');
                    } catch (error) {
                        console.error('保存修改失败:', error);
                        await showAlert('修改失败: ' + error.message);
                    }
                },

                // 评论相关方法
                async fetchComments() {
                    try {
                        const response = await apiService.getArticleComments(this.slug);
                        if (response.success && response.data) {
                            this.comments = response.data;
                        }
                    } catch (error) {
                        console.error('获取评论失败:', error);
                    }
                },

                async submitComment() {
                    if (!this.newCommentContent.trim()) return;

                    try {
                        const response = await apiService.addArticleComment(
                            this.slug,
                            this.newCommentContent.trim(),
                            0
                        );

                        if (response.success && response.data) {
                            // 添加到评论列表
                            this.comments.push(response.data);
                            // 清空输入框
                            this.newCommentContent = '';
                            // 更新评论计数
                            this.article.comments_count++;
                        }
                    } catch (error) {
                        console.error('提交评论失败:', error);
                        await showAlert('提交评论失败: ' + error.message);
                    }
                },

                replyToComment(commentId) {
                    this.replyTo = commentId;
                    this.replyContent = '';
                },

                cancelReply() {
                    this.replyTo = null;
                    this.replyContent = '';
                },

                async submitReply(parentId) {
                    if (!this.replyContent.trim()) return;

                    try {
                        const response = await apiService.addArticleComment(
                            this.slug,
                            this.replyContent.trim(),
                            parentId
                        );

                        if (response.success && response.data) {
                            // 添加到评论列表
                            this.comments.push(response.data);
                            // 清空输入框
                            this.replyContent = '';
                            this.replyTo = null;
                            // 更新评论计数
                            this.article.comments_count++;
                        }
                    } catch (error) {
                        console.error('提交回复失败:', error);
                        await showAlert('提交回复失败: ' + error.message);
                    }
                },

                getChildComments(parentId) {
                    // 查找所有直接或间接属于该一级评论的二级评论
                    const getParentComment = (commentId) => {
                        const comment = this.comments.find(c => c.comment_id === commentId);
                        return comment ? (comment.parent_comment_id === 0 ? comment : getParentComment(comment.parent_comment_id)) : null;
                    };

                    // 筛选出所有属于当前一级评论的二级评论
                    const childComments = this.comments.filter(comment => {
                        if (comment.parent_comment_id === 0) return false; // 排除一级评论
                        const rootComment = getParentComment(comment.parent_comment_id);
                        return rootComment && rootComment.comment_id === parentId;
                    });

                    // 按照创建时间排序，时间越大（越新）的评论展示越靠前
                    return childComments.sort((a, b) => b.created_at - a.created_at);
                },

                async toggleFeatured() {
                    // 显示确认弹窗
                    const action = this.article.tag_ids.includes('108') ? '取消精华' : '加精华';
                    if (!(await showConfirm(`确定要【${action}】这篇文章吗？`))) {
                        return; // 用户取消操作
                    }

                    try {
                        const response = await apiService.toggleFeatured(this.slug);
                        if (response.success) {
                            // 更新本地文章的featured_weight值
                            this.article.tag_ids.includes('108') ? this.article.tag_ids.replace('108', '') : this.article.tag_ids += '|108';
                            await showAlert(response.message);
                        }
                    } catch (error) {
                        console.error('操作失败:', error);
                        await showAlert('操作失败: ' + error.message);
                    }
                },

                // 检查用户是否是管理员
                isAdmin() {
                    return this.currentUser && (this.currentUser.role === 'admin' || this.currentUser.role === 'superadmin');
                },
            };
        }
    </script>

</body>

</html>