<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title x-text="pageTitle">加载中...</title>

    <link rel="stylesheet" href="css/pico.min.css">
    <link rel="stylesheet" href="font-awesome/css/all.min.css">
    <link rel="stylesheet" href="css/simplemde.min.css">
    <link rel="stylesheet" href="css/atom-one-dark.min.css">

    <script src="script/simplemde.min.js"></script>
    <script src="script/highlight.min.js"></script>
    <script src="script/cpp.min.js"></script>
    <script src="script/marked.min.js"></script>
    <script defer src="script/alpine.js"></script>

    <style>
        :root {
            --primary: #4f46e5;
            --primary-hover: #4338ca;
            --border-color: #e2e8f0;
            --muted-color: #6b7280;
            /* 代码块改为白色背景 */
            --code-background: #ffffff;
            --code-border: #e5e7eb;
        }

        body {
            padding-top: 20px;
            background-color: var(--pico-background-color) !important;
        }

        .container {
            max-width: 1200px;
        }

        .article-title {
            font-size: 1.8rem;
            color: var(--primary);
            margin: 1rem 0;
        }

        .article-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            font-size: 0.9rem;
            color: var(--muted-color);
            margin-bottom: 1.5rem;
        }

        .article-content {
            line-height: 1.8;
            font-size: 1.1rem;
            margin-bottom: 2rem;
        }

        /* 核心修改：白色背景代码块样式 */
        .article-content pre {
            background: var(--code-background) !important;
            border: 1px solid var(--code-border) !important; /* 加浅灰色边框区分 */
            padding: 1rem !important;
            border-radius: 8px !important; /* 圆角更柔和 */
            overflow-x: auto !important;
            margin: 1rem 0 !important;
        }

        /* 代码文字颜色适配白色背景（确保可读性） */
        .article-content code {
            font-family: Consolas, 'Fira Code', monospace !important;
            font-size: 0.95rem !important;

        }

        .article-content h1,
        .article-content h2,
        .article-content h3 {
            color: var(--primary);
            margin: 1.5rem 0 1rem;
        }

        .article-content p {
            margin-bottom: 1rem;
        }

        .article-content blockquote {
            border-left: 4px solid var(--primary);
            padding-left: 1rem;
            color: var(--muted-color);
            margin: 1rem 0;
            background: #f9fafb !important; /* 引用块也适配浅色 */
            padding: 1rem !important;
            border-radius: 4px !important;
        }

        .page-header {
            max-width: 1200px;
            width: 100%;
            padding: 1rem 2rem;
            margin: 0 auto;
            border-bottom: 1px solid var(--border-color);
        }
    </style>
</head>

<body>
    <!-- 统一页头占位符 -->
    <div id="header-container"></div>

    <main class="container" x-data="articleDetailComponent()" x-init="init()">
        <div x-show="isLoading" class="text-center py-4">
            <i class="fas fa-circle-o-notch fa-spin"></i> 正在加载文章...
        </div>

        <div x-show="errorMessage" class="alert alert-danger" role="alert" x-text="errorMessage"></div>

        <article x-show="!isLoading && !errorMessage && article.title" class="card">
            <div class="card-body">
                <h1 class="article-title" x-text="article.title"></h1>

                <div class="article-meta">
                    <span><i class="fas fa-user"></i> <span x-text="article.author_name"></span></span>
                    <span><i class="fas fa-tag"></i> <span x-text="article.tag_name"></span></span>
                    <span><i class="fas fa-calendar"></i> <span x-text="formatDate(article.created_at)"></span></span>
                    <span><i class="fas fa-eye"></i> <span x-text="article.views_count"></span> 浏览</span>
                </div>

                <div id="article-content" class="article-content"></div>

                <div class="comments-section" style="margin-top: 2rem; border-top: 1px solid var(--border-color); padding-top: 1rem;">
                    <h2>评论 (<span x-text="article.comments_count"></span>)</h2>
                    <p>评论区待实现</p>
                </div>
            </div>
        </article>
    </main>

        <!-- 统一页脚占位符 -->
    <div id="footer-container"></div>
    <!-- 统一布局脚本（包含用户信息管理功能） -->
    <script src="script/layout.js"></script>

    <script>
        marked.setOptions({
            gfm: true,
            breaks: true,
            sanitize: false,
            highlight: (code, lang) => {
                const language = hljs.getLanguage(lang) ? lang : 'plaintext';
                return hljs.highlight(code, { language }).value;
            },
            langPrefix: 'hljs language-'
        });

        hljs.configure({ ignoreUnescapedHTML: true, languages: ['cpp', 'c'] });

        document.addEventListener('alpine:init', () => {
            Alpine.data('articleDetailComponent', () => ({
                article: {},
                isLoading: true,
                errorMessage: '',

                get pageTitle() {
                    return this.article.title ? `${this.article.title} - PureCpp社区` : '文章详情 - PureCpp社区';
                },

                formatDate(timestamp) {
                    return timestamp ? new Date(timestamp).toLocaleString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' }) : '';
                },

                // 新增：修复重复高亮的核心函数
                highlightCodeBlocks() {
                    const codeBlocks = document.querySelectorAll('#article-content pre code');
                    codeBlocks.forEach(block => {
                        // 移除已高亮标记，避免重复警告
                        if (block.dataset.highlighted === 'yes') {
                            delete block.dataset.highlighted;
                        }
                        // 单次高亮当前代码块
                        hljs.highlightElement(block);
                    });
                },

                renderMarkdown(content) {
                    const contentEl = document.getElementById('article-content');
                    if (!contentEl || !content) return;
                    
                    const unescaped = content.replace(/\\n/g, '\n').replace(/\\t/g, '\t');
                    const html = marked.parse(unescaped);
                    
                    contentEl.innerHTML = html;
                    
                    // 替换原有 hljs.highlightAll() 为精准高亮
                    setTimeout(() => this.highlightCodeBlocks(), 50);
                },

                async fetchArticle() {
                    const slug = new URLSearchParams(window.location.search).get('slug');
                    if (!slug) {
                        this.errorMessage = '缺少文章标识符 (slug)';
                        this.isLoading = false;
                        return;
                    }

                    try {
                        const res = await fetch(`/api/v1/article/${slug}`);
                        if (!res.ok) throw new Error('接口请求失败');
                        
                        const data = await res.json();
                        this.article = data.data;
                        
                        this.renderMarkdown(this.article.content);
                        
                        this.isLoading = false;
                    } catch (e) {
                        this.errorMessage = `加载失败：${e.message}`;
                        this.isLoading = false;
                    }
                },

                init() {
                    this.fetchArticle();
                }
            }));
        });

        document.addEventListener('DOMContentLoaded', async () => {
            const container = document.getElementById('header-container');
            if (!container) return;
            try {
                const res = await fetch('header.html');
                if (res.ok) container.innerHTML = await res.text();
            } catch (e) {
                console.log('Header 加载失败');
            }
        });
    </script>
</body>
</html>