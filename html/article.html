<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title x-text="pageTitle">åŠ è½½ä¸­...</title>

    <link rel="stylesheet" href="css/pico.min.css">
    <link rel="stylesheet" href="font-awesome/css/all.min.css">
    <link rel="stylesheet" href="css/simplemde.min.css">
    <link rel="stylesheet" href="css/atom-one-dark.min.css">
    <!-- PureCpp ç»Ÿä¸€æ ·å¼ -->
    <link rel="stylesheet" href="css/purecpp.css">

    <script src="script/simplemde.min.js"></script>
    <script src="script/highlight.min.js"></script>
    <script src="script/cpp.min.js"></script>
    <script src="script/marked.min.js"></script>
    <script defer src="script/alpine.js"></script>

    <style>
        /* ä»£ç å—æ ·å¼ï¼ˆä¸ªæ€§åŒ–ï¼‰ */
        .article-content pre {
            background: var(--code-background) !important;
            border: 1px solid var(--code-border) !important;
            padding: 1rem !important;
            border-radius: 8px !important;
            overflow-x: auto !important;
            margin: 1rem 0 !important;
        }

        .article-content code {
            font-family: Consolas, 'Fira Code', monospace !important;
            font-size: 0.95rem !important;
        }

        .article-content blockquote {
            border-left: 4px solid var(--primary);
            padding-left: 1rem;
            color: var(--muted-color);
            margin: 1rem 0;
            background: #f9fafb !important;
            padding: 1rem !important;
            border-radius: 4px !important;
        }

        /* è‡ªå®šä¹‰ä¸‹æ‹‰æ ·å¼ï¼ˆä¸ªæ€§åŒ–ï¼‰ */
        .dropdown {
            position: relative;
            display: inline-block;
            width: 600px;
        }

        .search-box {
            margin-bottom: 0.5rem;
        }

        /* è¡¨æƒ…ç›¸å…³æ ·å¼ */
        .emoji-reaction {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 1rem;
            font-size: 0.8rem;
            cursor: pointer;
            margin-right: 0.5rem;
            transition: all 0.2s ease;
        }

        .emoji-reaction:hover {
            background-color: var(--bg-secondary);
            transform: translateY(-1px);
        }

        .emoji-reaction.reacted {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .emoji-reaction i {
            font-size: 1rem;
        }

        .reaction-emoji {
            display: inline-block;
            font-size: 1.2rem;
            cursor: pointer;
            margin: 0 0.25rem;
            transition: transform 0.2s ease;
        }

        .reaction-emoji:hover {
            transform: scale(1.2);
        }

        .emoji-picker {
            display: none;
            grid-template-columns: repeat(12, 1fr);
            gap: 0.5rem;
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--bg-card);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            width: 480px;
            max-height: 300px;
            overflow-y: auto;
        }

        .emoji-item {
            font-size: 1.2rem;
            text-align: center;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .emoji-item:hover {
            background-color: var(--bg-secondary);
            transform: scale(1.2);
        }
    </style>
</head>

<body>
    <!-- ç»Ÿä¸€é¡µå¤´å ä½ç¬¦ -->
    <div id="header-container"></div>

    <main class="page-wrapper" x-data="articleDetailComponent()">
        <div x-show="isLoading" class="text-center py-4">
            <i class="fas fa-circle-o-notch fa-spin"></i> æ­£åœ¨åŠ è½½æ–‡ç« ...
        </div>

        <div x-show="errorMessage" class="alert alert-danger" role="alert" x-text="errorMessage"></div>

        <!-- åŠ ç²¾åå›¾æ ‡ï¼šä»…ç®¡ç†å‘˜å¯è§ -->
        <div x-show="currentUser && (currentUser.role === 'admin' || currentUser.role === 'superadmin') && !isLoading && !errorMessage && article.title"
             @click="toggleFeatured()"
             style="position: fixed; right: 50px; top: 50%; transform: translateY(-50%); cursor: pointer; z-index: 1000; margin: 0; padding: 0; border: none; background: transparent; overflow: visible;">
            <img :src="(article.tag_ids && article.tag_ids.includes('108')) ? 'images/recommend.png' : 'images/recommend.png'"
                 :style="(article.tag_ids && article.tag_ids.includes('108')) ? 'width: 64px; height: 64px; opacity: 1; display: block; background: transparent;' : 'width: 64px; height: 64px; opacity: 0.6; display: block; background: transparent;'"
                 :title="(article.tag_ids && article.tag_ids.includes('108')) ? 'å–æ¶ˆç²¾å' : 'åŠ ç²¾å'"
                 style="margin: 0; padding: 0; border: none; background: transparent; box-shadow: none;">
        </div>

        <article x-show="!isLoading && !errorMessage && article.title" class="card">
            <div class="card-body">
                <h1 class="article-title" style="display: flex; align-items: center; justify-content: space-between;">
                    <span x-text="article.title"></span>
                </h1>

                <div class="article-meta">
                    <span><i class="fas fa-user"></i> <span x-text="article.author_name"></span></span>
                    <span><i class="fas fa-tag"></i>
                        <template x-if="article.tag_ids">
                            <template x-for="tagId in article.tag_ids.split('|')" :key="tagId">
                                <template x-if="getTagName(tagId)">
                                    <span class="tag" style="margin-right: 5px;" x-text="getTagName(tagId)"></span>
                                </template>
                            </template>
                        </template>
                    </span>
                    <span><i class="fas fa-calendar"></i> <span x-text="formatDate(article.created_at)"></span></span>
                    <span><i class="fas fa-eye"></i> <span x-text="article.views_count"></span> æµè§ˆ</span>

                    <!-- ç¼–è¾‘æŒ‰é’®ï¼šä»…ä½œè€…å¯è§ -->
                    <span x-show="currentUser && currentUser.username === article.author_name" @click="startEdit()"
                          style="cursor: pointer; color: #007bff; margin-left: 10px;">
                        <i class="fas fa-edit"></i> ç¼–è¾‘
                    </span>
                </div>

                <div x-show="!isEditing" id="article-content" class="article-content"></div>
                <!-- ç¼–è¾‘æ¨¡å¼ï¼šå¤ç”¨æ’°å†™æ–‡ç« çš„ textarea ç»“æ„ -->
                <div x-show="isEditing" x-cloak style="margin-top: 1rem;">
                    <label>æ–‡ç« æ‘˜è¦</label>
                    <textarea x-model="excerpt" rows="3" style="width: 100%; margin-bottom: 1rem;"></textarea>

                    <label>æ–‡ç« å†…å®¹ (Markdown)</label>
                    <textarea id="markdown-editor" x-model="content" rows="20"
                              style="width: 100%; font-family: monospace;"></textarea>


                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                        <label for="tag-select" style="margin: 0; white-space: nowrap;">é€‰æ‹©æ ‡ç­¾</label>
                        <!-- æ–°çš„å¤šé€‰ç»„ä»¶ -->
                        <div class="dropdown" @click.outside="open = false" style="flex: 1;">
                            <!-- è§¦å‘æŒ‰é’® -->
                            <button type="button" @click="open = !open"
                                    style="width: 100%; text-align: left; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--bg-card); color: var(--text-main); padding: 0.5rem 0.8rem; height: 46px; box-sizing: border-box;">
                                <template x-if="selectedTagIds.length === 0"><span
                                        style="color: var(--muted-color);">è¯·é€‰æ‹©é€‰é¡¹</span>
                                </template>
                                <template x-if="selectedTagIds && selectedTagIds.length > 0">
                                    <span x-text="getSelectedTagNames()"></span>
                                </template>
                            </button>
                            <!-- ä¸‹æ‹‰èœå• -->
                            <div class="dropdown-menu" x-show="open" x-transition style="width: 100%;">
                                <template x-for="tag in tags" :key="tag.tag_id">
                                    <label>
                                        <input type="checkbox" :value="tag.tag_id" @change="toggleTag(tag.tag_id)"
                                               :checked="selectedTagIds && selectedTagIds.some(id => id == tag.tag_id)">
                                        <span x-text="tag.name"></span>
                                    </label>
                                </template>
                            </div>
                        </div>
                    </div>
                    <div style="margin-top: 1rem; display: flex; justify-content: center; gap: 1rem;">
                        <button @click="saveChanges()" class="primary">ä¿å­˜ä¿®æ”¹</button>
                        <button @click="cancelEdit()" class="secondary">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>
            <div class="comments-section"
                 style="margin-top: 2rem; border-top: 1px solid var(--border-color); padding-top: 1rem;">
                <h2>è¯„è®º (<span x-text="article.comments_count"></span>)</h2>

                <!-- è¯„è®ºè¡¨å• -->
                <div class="comment-form" x-show="currentUser"
                     style="margin-bottom: 2rem; padding: 1rem; border: 1px solid var(--border-color); border-radius: 8px;">
                    <h3>å‘è¡¨è¯„è®º</h3>
                    <div style="position: relative; margin-bottom: 1rem;">
                        <textarea x-model="newCommentContent" rows="4" placeholder="å†™ä¸‹ä½ çš„è¯„è®º..."
                                  style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px;"></textarea>
                        <div class="emoji-picker" id="emoji-picker"></div>
                        <button class="action-button" id="emoji-btn" title="è¡¨æƒ…"
                                style="position: absolute; bottom: 0.5rem; right: 0.5rem; background: none; border: none; font-size: 1.2rem; cursor: pointer;">
                            ğŸ˜Š
                        </button>
                    </div>
                    <div style="display: flex; justify-content: flex-end;">
                        <button @click="submitComment" :disabled="!newCommentContent.trim()"
                                style="padding: 0.5rem 1rem; background-color: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer;">
                            æäº¤è¯„è®º
                        </button>
                    </div>
                </div>

                <!-- æœªç™»å½•æç¤º -->
                <div x-show="!currentUser"
                     style="margin-bottom: 2rem; padding: 1rem; background-color: #f8f9fa; border-radius: 8px;">
                    <p>è¯·<a href="/login.html">ç™»å½•</a>åå‘è¡¨è¯„è®º</p>
                </div>

                <!-- è¯„è®ºåˆ—è¡¨ -->
                <div class="comments-list" style="margin-top: 1rem;">
                    <template
                            x-for="comment in comments.filter(c => c.parent_comment_id === 0).sort((a, b) => b.created_at - a.created_at)"
                            :key="comment.comment_id">
                        <div class="comment-item"
                             style="margin-bottom: 1rem; padding: 1rem; border: 1px solid var(--border-color); border-radius: 8px;">
                            <div class="comment-header"
                                 style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <span class="comment-author" style="font-weight: bold; color: var(--primary);"
                                      x-text="comment.author_name"></span>
                            </div>
                            <div class="comment-content" style="margin-bottom: 0.5rem; line-height: 1.5;"
                                 x-html="comment.content"></div>
                            <div class="comment-footer"
                                 style="display: flex; justify-content: space-between; align-items: center; font-size: 0.75rem;">
                                <div style="display: flex; gap: 1rem; font-size: 0.8rem; color: var(--muted-color);">
                                    <span class="comment-time" x-text="formatDate(comment.created_at)"></span>
                                    <span class="comment-ip" x-text="comment.ip || ''"></span>
                                </div>
                                <div class="comment-actions" style="font-size: 0.8rem; margin-left: 0.5rem;">
                                    <button @click="replyToComment(comment.comment_id)"
                                            style="background: none; border: none; color: var(--primary); cursor: pointer; padding: 0; margin-right: 1rem;">
                                        å›å¤
                                    </button>
                                    <button x-show="isAdmin()" @click="deleteComment(comment.comment_id)"
                                            style="background: none; border: none; color: #dc3545; cursor: pointer; padding: 0;">
                                        åˆ é™¤
                                    </button>
                                </div>
                            </div>


                            <!-- å›å¤è¡¨å• -->
                            <div class="reply-form" x-show="replyTo === comment.comment_id">
                                <div style="position: relative; margin-bottom: 1rem;">
                                    <textarea x-model="replyContent" rows="3" placeholder="å›å¤è¯„è®º..."></textarea>
                                    <div class="emoji-picker" :id="'emoji-picker-reply-' + comment.comment_id"></div>
                                    <button class="action-button" :id="'emoji-btn-reply-' + comment.comment_id"
                                            title="è¡¨æƒ…"
                                            style="position: absolute; bottom: 0.5rem; right: 0.5rem; background: none; border: none; font-size: 1.2rem; cursor: pointer;"
                                            @click="showEmojiPicker('reply-' + comment.comment_id, $event)">
                                        ğŸ˜Š
                                    </button>
                                </div>
                                <div class="reply-form-actions">
                                    <button @click="cancelReply" class="reply-form-cancel">å–æ¶ˆ</button>
                                    <button @click="submitReply(comment.comment_id)" :disabled="!replyContent.trim()"
                                            class="reply-form-submit">å›å¤
                                    </button>
                                </div>
                            </div>

                            <!-- å­è¯„è®º -->
                            <div class="child-comments"
                                 style="margin-left: 2rem; margin-top: 1rem; border-left: 2px solid var(--border-color); padding-left: 1rem;">
                                <template x-for="child in getChildComments(comment.comment_id)" :key="child.comment_id">
                                    <div class="child-comment-item"
                                         style="margin-bottom: 0.75rem; padding: 0.75rem; background-color: #f8f9fa; border-radius: 4px;">
                                        <!-- å›å¤æ ‡é¢˜ï¼šxxå›å¤xx -->
                                        <div class="reply-title"
                                             style="font-size: 0.75rem; color: var(--muted-color); margin-bottom: 0.3rem;">
                                            <span x-text="child.author_name"></span> å›å¤ <span
                                                x-text="child.parent_user_name"></span>
                                        </div>

                                        <div class="comment-content"
                                             style="margin-bottom: 0.3rem; line-height: 1.4; font-size: 0.9rem;"
                                             x-html="child.content"></div>

                                        <div class="comment-footer"
                                             style="display: flex; justify-content: space-between; align-items: center; font-size: 0.75rem;">
                                            <div style="display: flex; gap: 0.75rem; color: var(--muted-color);">
                                                <span class="comment-time" x-text="formatDate(child.created_at)"></span>
                                                <span class="comment-ip" x-text="child.ip || ''"></span>
                                            </div>
                                            <div style="display: flex; gap: 1rem;">
                                                <button @click="replyToComment(child.comment_id)"
                                                    style="background: none; border: none; color: var(--primary); cursor: pointer; padding: 0;">
                                                    å›å¤
                                                </button>
                                                <button x-show="isAdmin()" @click="deleteComment(child.comment_id)"
                                                        style="background: none; border: none; color: #dc3545; cursor: pointer; padding: 0;">
                                                    åˆ é™¤
                                                </button>
                                            </div>
                                        </div>

                                        <!-- å­è¯„è®ºçš„å›å¤è¡¨å• -->
                                        <div class="reply-form" x-show="replyTo === child.comment_id">
                                            <div style="position: relative; margin-bottom: 1rem;">
                                                <textarea x-model="replyContent" rows="2"
                                                          placeholder="å›å¤è¯„è®º..."></textarea>
                                                <div class="emoji-picker"
                                                     :id="'emoji-picker-reply-' + child.comment_id"></div>
                                                <button class="action-button"
                                                        :id="'emoji-btn-reply-' + child.comment_id" title="è¡¨æƒ…"
                                                        style="position: absolute; bottom: 0.5rem; right: 0.5rem; background: none; border: none; font-size: 1.2rem; cursor: pointer;"
                                                        @click="showEmojiPicker('reply-' + child.comment_id, $event)">
                                                    ğŸ˜Š
                                                </button>
                                            </div>
                                            <div class="reply-form-actions">
                                                <button @click="cancelReply" class="reply-form-cancel">å–æ¶ˆ</button>
                                                <button @click="submitReply(child.comment_id)"
                                                        :disabled="!replyContent.trim()" class="reply-form-submit">å›å¤
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>

                    <!-- æš‚æ— è¯„è®º -->
                    <div x-show="comments.length === 0"
                         style="text-align: center; padding: 2rem; color: var(--muted-color);">
                        <p>æš‚æ— è¯„è®ºï¼Œå¿«æ¥å‘è¡¨ç¬¬ä¸€æ¡è¯„è®ºå§ï¼</p>
                    </div>
                </div>
            </div>
        </article>
    </main>

    <!-- ç»Ÿä¸€é¡µè„šå ä½ç¬¦ -->
    <div id="footer-container"></div>
    <!-- APIæœåŠ¡è„šæœ¬ -->
    <script src="script/api_service.js"></script>
    <!-- ç»Ÿä¸€å¸ƒå±€è„šæœ¬ï¼ˆåŒ…å«ç”¨æˆ·ä¿¡æ¯ç®¡ç†åŠŸèƒ½ï¼‰ -->
    <script src="script/layout.js"></script>

    <script>
        marked.setOptions({
            gfm: true,
            breaks: true,
            sanitize: false,
            highlight: (code, lang) => {
                const language = hljs.getLanguage(lang) ? lang : 'plaintext';
                return hljs.highlight(code, { language }).value;
            },
            langPrefix: 'hljs language-'
        });

        hljs.configure({ ignoreUnescapedHTML: true, languages: ['cpp', 'c'] });

        // ç”¨æˆ·èµ„æ–™å¼¹çª—åŠŸèƒ½
        (function () {
            // åˆ›å»ºå…¨å±€å¼¹çª—å®¹å™¨
            const popupContainer = document.createElement('div');
            popupContainer.className = 'user-profile-popup';
            popupContainer.style.display = 'none';
            popupContainer.style.position = 'fixed';
            document.body.appendChild(popupContainer);

            let currentUsername = null;
            let timer = null;

            // æ ¼å¼åŒ–æ—¥æœŸ
            function formatDate(timestamp) {
                const date = new Date(timestamp);
                return date.toLocaleDateString('zh-CN', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            }

            // æ˜¾ç¤ºç”¨æˆ·èµ„æ–™å¼¹çª—
            async function showUserProfilePopup(username, x, y) {
                if (currentUsername === username) {
                    return;
                }

                currentUsername = username;
                popupContainer.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
                popupContainer.style.display = 'block';
                popupContainer.style.left = `${x}px`;
                popupContainer.style.top = `${y}px`;

                try {
                    const response = await apiService.getUserProfile(username);
                    if (response.success && response.data) {
                        const user = response.data;
                        const levelText = apiService.getLevelText(user.level);

                        // æ„å»ºå¼¹çª—å†…å®¹
                        popupContainer.innerHTML = `
                            <div class="popup-header">
                                <img src="${user.avatar}"
                                     alt="${user.username}" class="avatar">
                                <div class="user-info">
                                    <h4>${user.username}</h4>
                                    <p>${user.title || 'ç”¨æˆ·'}</p>
                                </div>
                            </div>
                            ${user.bio ? `<div class="user-bio">${user.bio}</div>` : ''}
                            <div class="user-details">
                                <div class="detail-item">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <span>${user.location || 'æœªçŸ¥'}</span>
                                </div>
                                <div class="detail-item">
                                    <i class="fas fa-star"></i>
                                    <span>${levelText}</span>
                                </div>
                                <div class="detail-item">
                                    <i class="fas fa-calendar"></i>
                                    <span>æ³¨å†Œäº ${formatDate(user.created_at)}</span>
                                </div>
                                ${user.skills ? `
                                <div class="detail-item">
                                    <i class="fas fa-tags"></i>
                                    <span>${user.skills}</span>
                                </div>
                                ` : ''}
                                <div class="detail-item">
                                    <i class="fas fa-circle"></i>
                                    <span>${user.status}</span>
                                </div>
                            </div>
                        `;
                    }
                } catch (error) {
                    console.error('è·å–ç”¨æˆ·èµ„æ–™å¤±è´¥:', error);
                    popupContainer.innerHTML = '<div class="loading">è·å–ç”¨æˆ·èµ„æ–™å¤±è´¥</div>';
                }
            }

            // éšè—ç”¨æˆ·èµ„æ–™å¼¹çª—
            function hideUserProfilePopup() {
                currentUsername = null;
                popupContainer.style.display = 'none';
            }

            // ä¸ºæ‰€æœ‰ç”¨æˆ·åæ·»åŠ æ‚¬åœäº‹ä»¶
            function initUserProfileHover() {
                // åœ¨Alpine.jsæ¸²æŸ“å®Œæˆåæ‰§è¡Œ
                setTimeout(() => {
                    // ä¸ºarticle.htmlä¸­çš„ç”¨æˆ·åæ·»åŠ æ‚¬åœäº‹ä»¶

                    // 1. æ–‡ç« ä½œè€…ç”¨æˆ·å
                    const articleAuthor = document.querySelector('.article-meta span:first-child span');
                    if (articleAuthor) {
                        articleAuthor.className = 'username-hover';
                        articleAuthor.addEventListener('mouseenter', function (e) {
                            const username = this.textContent.trim();
                            const rect = this.getBoundingClientRect();
                            const x = rect.left + window.pageXOffset;
                            const y = rect.bottom + window.pageYOffset + 5;

                            timer = setTimeout(() => {
                                showUserProfilePopup(username, x, y);
                            }, 300);
                        });

                        articleAuthor.addEventListener('mouseleave', function () {
                            clearTimeout(timer);
                        });
                    }

                    // 2. è¯„è®ºä½œè€…ç”¨æˆ·å
                    document.querySelectorAll('.comment-author').forEach(usernameElement => {
                        usernameElement.className = 'username-hover';
                        usernameElement.addEventListener('mouseenter', function (e) {
                            const username = this.textContent.trim();
                            const rect = this.getBoundingClientRect();
                            const x = rect.left + window.pageXOffset;
                            const y = rect.bottom + window.pageYOffset + 5;

                            timer = setTimeout(() => {
                                showUserProfilePopup(username, x, y);
                            }, 300);
                        });

                        usernameElement.addEventListener('mouseleave', function () {
                            clearTimeout(timer);
                        });
                    });
                }, 500);
            }

            // åˆå§‹åŒ–ç”¨æˆ·èµ„æ–™æ‚¬åœåŠŸèƒ½
            document.addEventListener('DOMContentLoaded', initUserProfileHover);

            // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹å…³é—­å¼¹çª—
            document.addEventListener('click', function (e) {
                if (!e.target.closest('.username-hover') && !e.target.closest('.user-profile-popup')) {
                    hideUserProfilePopup();
                }
            });

            // ç›‘å¬Alpine.jsçš„æ›´æ–°äº‹ä»¶ï¼Œé‡æ–°åˆå§‹åŒ–æ‚¬åœäº‹ä»¶
            document.addEventListener('alpine:init', initUserProfileHover);
        })();

        function articleDetailComponent() {
            return {
                article: {},
                isLoading: true,
                errorMessage: '',
                currentUser: null,
                isEditing: false,
                tags: [],
                selectedTagIds: [],
                open: false,
                simplemde: null,
                slug: '',
                title: '',
                excerpt: '',
                content: '',
                // è¯„è®ºç›¸å…³æ•°æ®
                comments: [],
                newCommentContent: '',
                replyTo: null,
                replyContent: '',

                // è¡¨æƒ…ç›¸å…³æ–¹æ³•
                showEmojiPicker(pickerId, event) {
                    event.stopPropagation();

                    // éšè—æ‰€æœ‰å…¶ä»–è¡¨æƒ…é€‰æ‹©å™¨
                    document.querySelectorAll('.emoji-picker').forEach(picker => {
                        picker.style.display = 'none';
                    });

                    const emojiPicker = document.getElementById('emoji-picker' + (pickerId ? '-' + pickerId : ''));
                    if (!emojiPicker) return;

                    if (emojiPicker.style.display === 'grid') {
                        emojiPicker.style.display = 'none';
                        return;
                    }

                    // æ¸…ç©ºå¹¶é‡æ–°å¡«å……è¡¨æƒ…
                    emojiPicker.innerHTML = '';
                    commonEmojis.forEach(emoji => {
                        const span = document.createElement('span');
                        span.className = 'emoji-item';
                        span.textContent = emoji;
                        span.addEventListener('click', () => {
                            if (pickerId && pickerId.startsWith('reply-')) {
                                this.insertAtCursor('replyContent', emoji);
                            } else {
                                this.insertAtCursor('newCommentContent', emoji);
                            }
                            emojiPicker.style.display = 'none';
                        });
                        emojiPicker.appendChild(span);
                    });

                    // å®šä½è¡¨æƒ…é€‰æ‹©å™¨
                    const btn = event.currentTarget;
                    const rect = btn.getBoundingClientRect();
                    const container = btn.closest('div');
                    const containerRect = container.getBoundingClientRect();

                    emojiPicker.style.position = 'absolute';
                    emojiPicker.style.bottom = `${containerRect.bottom - rect.top + 10}px`;
                    emojiPicker.style.right = `${containerRect.right - rect.right}px`;
                    emojiPicker.style.display = 'grid';
                },

                insertAtCursor(fieldName, emoji) {
                    if (fieldName === 'newCommentContent') {
                        this.newCommentContent += emoji;
                    } else if (fieldName === 'replyContent') {
                        this.replyContent += emoji;
                    }
                },

                get pageTitle() {
                    return this.article.title ? `${this.article.title} - PureCppç¤¾åŒº` : 'æ–‡ç« è¯¦æƒ… - PureCppç¤¾åŒº';
                },

                formatDate(timestamp) {
                    if (!timestamp) return '';

                    const commentDate = new Date(timestamp);
                    const now = new Date();
                    const diffMs = now - commentDate;
                    const diffMinutes = Math.floor(diffMs / (1000 * 60));
                    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

                    // åŠå°æ—¶ä»¥å†…æ˜¾ç¤ºâ€œåˆšåˆšâ€
                    if (diffMinutes < 30) {
                        return 'åˆšåˆš';
                    }

                    if (diffMinutes < 60) {
                        return `åŠå°æ—¶ä»¥å‰`;
                    }

                    // 12å°æ—¶ä»¥å†…æ˜¾ç¤ºâ€œå‡ å°æ—¶ä»¥å‰â€
                    if (diffHours < 12) {
                        return `${diffHours}å°æ—¶ä»¥å‰`;
                    }

                    // 3å¤©ä»¥å†…æ˜¾ç¤ºâ€œå‡ å¤©å‰â€
                    if (diffDays < 3) {
                        return `${diffDays}å¤©å‰`;
                    }

                    // è¶…è¿‡3å¤©ï¼Œåˆ¤æ–­æ˜¯å¦åœ¨ä»Šå¹´å†…
                    const isSameYear = now.getFullYear() === commentDate.getFullYear();

                    if (isSameYear) {
                        // ä»Šå¹´å†…æ˜¾ç¤ºâ€œå‡ æœˆå‡ å·â€
                        return commentDate.toLocaleString('zh-CN', {
                            month: 'long',
                            day: 'numeric'
                        });
                    } else {
                        // ä»Šå¹´ä»¥å‰æ˜¾ç¤ºâ€œå‡ å¹´å‡ æœˆå‡ æ—¥â€
                        return commentDate.toLocaleString('zh-CN', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        });
                    }
                },

                // æ ¹æ®æ ‡ç­¾IDè·å–æ ‡ç­¾åç§°
                getTagName(tagId) {
                    const tag = this.tags.find(t => t.tag_id == tagId);
                    return tag ? tag.name : '';
                },

                // æ–°å¢ï¼šä¿®å¤é‡å¤é«˜äº®çš„æ ¸å¿ƒå‡½æ•°
                highlightCodeBlocks() {
                    const codeBlocks = document.querySelectorAll('#article-content pre code');
                    codeBlocks.forEach(block => {
                        // ç§»é™¤å·²é«˜äº®æ ‡è®°ï¼Œé¿å…é‡å¤è­¦å‘Š
                        if (block.dataset.highlighted === 'yes') {
                            delete block.dataset.highlighted;
                        }
                        // å•æ¬¡é«˜äº®å½“å‰ä»£ç å—
                        hljs.highlightElement(block);
                    });
                },

                renderMarkdown(content) {
                    const contentEl = document.getElementById('article-content');
                    if (!contentEl || !content) return;

                    const unescaped = content.replace(/\\n/g, '\n').replace(/\\t/g, '\t');
                    const html = marked.parse(unescaped);

                    contentEl.innerHTML = html;

                    // æ›¿æ¢åŸæœ‰ hljs.highlightAll() ä¸ºç²¾å‡†é«˜äº®
                    setTimeout(() => this.highlightCodeBlocks(), 50);
                },

                async fetchArticle() {
                    const slug = new URLSearchParams(window.location.search).get('slug');
                    if (!slug) {
                        this.errorMessage = 'ç¼ºå°‘æ–‡ç« æ ‡è¯†ç¬¦ (slug)';
                        this.isLoading = false;
                        return;
                    }

                    this.slug = slug;

                    // ä½¿ç”¨apiServiceè·å–ç”¨æˆ·ä¿¡æ¯
                    this.currentUser = apiService.getUserInfo();

                    try {
                        // ä½¿ç”¨apiServiceè·å–æ–‡ç« ä¿¡æ¯
                        const response = await apiService.getArticle(slug);
                        this.article = response.data;

                        this.renderMarkdown(this.article.content);

                        // åŠ è½½è¯„è®º
                        await this.fetchComments();

                        this.isLoading = false;
                    } catch (e) {
                        this.errorMessage = `åŠ è½½å¤±è´¥ï¼š${e.message}`;
                        this.isLoading = false;
                    }
                },

                async init() {
                    await this.fetchTags();
                    await this.fetchArticle();

                    // åˆå§‹åŒ–è¡¨æƒ…æŒ‰é’®äº‹ä»¶
                    this.initEmojiButtons();
                },

                initEmojiButtons() {
                    // ä¸»è¯„è®ºè¡¨å•çš„è¡¨æƒ…æŒ‰é’®
                    const emojiBtn = document.getElementById('emoji-btn');
                    if (emojiBtn) {
                        emojiBtn.addEventListener('click', (event) => {
                            this.showEmojiPicker('', event);
                        });
                    }

                    // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹å…³é—­è¡¨æƒ…é€‰æ‹©å™¨
                    document.addEventListener('click', (event) => {
                        if (!event.target.closest('.action-button') && !event.target.closest('.emoji-picker')) {
                            document.querySelectorAll('.emoji-picker').forEach(picker => {
                                picker.style.display = 'none';
                            });
                        }
                    });
                },

                async fetchTags() {
                    try {
                        // ä½¿ç”¨apiServiceè·å–æ ‡ç­¾åˆ—è¡¨
                        const response = await apiService.getTags();
                        this.tags = response.data;
                    } catch (error) {
                        console.error('è·å–æ ‡ç­¾å¤±è´¥:', error);
                        this.errorMessage = 'æ— æ³•åŠ è½½æ ‡ç­¾æ•°æ®ï¼Œè¯·ç¨åé‡è¯•ã€‚';
                    }
                },

                // è¿›å…¥ç¼–è¾‘çŠ¶æ€
                startEdit() {
                    this.isEditing = true;
                    // å°†åŸå§‹æ•°æ®åŒæ­¥åˆ°ç¼–è¾‘è¡¨å•ï¼ˆé¿å…ç›´æ¥ä¿®æ”¹åŸæ–‡ç« å¯¹è±¡ï¼‰
                    this.title = this.article.title;
                    this.excerpt = this.article.summary || '';
                    this.content = this.article.content;

                    if (this.article.content) {
                        this.content = this.article.content.replace(/\\n/g, '\n').replace(/\\t/g, '\t');
                    } else {
                        this.content = '';
                    }

                    // åˆå§‹åŒ–é€‰ä¸­çš„æ ‡ç­¾
                    if (this.article.tag_ids) {
                        this.selectedTagIds = this.article.tag_ids.split('|');
                    } else {
                        this.selectedTagIds = [];
                    }

                    this.$nextTick(() => {
                        this.initializeSimpleMDE();
                    });
                },

                // åˆ‡æ¢æ ‡ç­¾é€‰æ‹©çŠ¶æ€
                toggleTag(tag_id) {
                    const index = this.selectedTagIds.indexOf(tag_id);
                    if (index === -1) {
                        this.selectedTagIds.push(tag_id);
                    } else {
                        this.selectedTagIds.splice(index, 1);
                    }
                },

                // è·å–é€‰ä¸­çš„æ ‡ç­¾åç§°
                getSelectedTagNames() {
                    if (!this.selectedTagIds) {
                        return '';
                    }
                    return this.selectedTagIds.map(tagId => {
                        const tag = this.tags.find(t => t.tag_id == tagId);
                        return tag ? tag.name : tagId;
                    }).join(', ');
                },

                initializeSimpleMDE() {
                    if (this.simplemde) return;
                    // --- å®ä¾‹åŒ– SimpleMDE ---
                    this.simplemde = new SimpleMDE({
                        element: document.getElementById("markdown-editor"),
                        spellChecker: false,

                        // è¦†ç›–é»˜è®¤çš„é¢„è§ˆæ¸²æŸ“å‡½æ•°
                        previewRender: function (plainText, preview) {
                            return marked.parse(plainText);
                        },
                    });

                    // ç›‘å¬ç¼–è¾‘å™¨çš„ change äº‹ä»¶ï¼ŒåŒæ­¥æ•°æ®åˆ° Alpine çš„ content å˜é‡
                    this.simplemde.codemirror.on("change", () => {
                        this.content = this.simplemde.value();
                    });
                },

                cancelEdit() {
                    this.isEditing = false;
                },

                async saveChanges() {
                    try {
                        // å°†é€‰ä¸­çš„æ ‡ç­¾IDæ•°ç»„è½¬æ¢ä¸ºä»¥|åˆ†éš”çš„å­—ç¬¦ä¸²
                        const tagIds = this.selectedTagIds.join('|');
                        // ä½¿ç”¨apiServiceä¿å­˜æ–‡ç« ä¿®æ”¹
                        const response = await apiService.editArticle(
                            this.slug,
                            this.title,
                            this.excerpt,
                            this.content,
                            tagIds,
                            this.currentUser.username
                        );

                        // æ›´æ–°æœ¬åœ°æ˜¾ç¤º
                        this.article.title = this.title;
                        this.article.content = this.content;
                        this.article.summary = this.excerpt;
                        this.renderMarkdown(this.article.content);
                        this.isEditing = false;
                        await showAlert('ä¿®æ”¹æˆåŠŸï¼');
                    } catch (error) {
                        console.error('ä¿å­˜ä¿®æ”¹å¤±è´¥:', error);
                        await showAlert('ä¿®æ”¹å¤±è´¥: ' + error.message);
                    }
                },

                // è¯„è®ºç›¸å…³æ–¹æ³•
                async fetchComments() {
                    try {
                        const response = await apiService.getArticleComments(this.slug);
                        if (response.success && response.data) {
                            this.comments = response.data;
                        }
                    } catch (error) {
                        console.error('è·å–è¯„è®ºå¤±è´¥:', error);
                    }
                },

                async submitComment() {
                    if (!this.newCommentContent.trim()) return;

                    try {
                        const response = await apiService.addArticleComment(
                            this.slug,
                            this.newCommentContent.trim(),
                            0
                        );

                        if (response.success && response.data) {
                            // æ·»åŠ åˆ°è¯„è®ºåˆ—è¡¨
                            this.comments.push(response.data);
                            // æ¸…ç©ºè¾“å…¥æ¡†
                            this.newCommentContent = '';
                            // æ›´æ–°è¯„è®ºè®¡æ•°
                            this.article.comments_count++;
                        }
                    } catch (error) {
                        console.error('æäº¤è¯„è®ºå¤±è´¥:', error);
                        await showAlert('æäº¤è¯„è®ºå¤±è´¥: ' + error.message);
                    }
                },

                replyToComment(commentId) {
                    this.replyTo = commentId;
                    this.replyContent = '';
                },

                cancelReply() {
                    this.replyTo = null;
                    this.replyContent = '';
                },

                async submitReply(parentId) {
                    if (!this.replyContent.trim()) return;

                    try {
                        const response = await apiService.addArticleComment(
                            this.slug,
                            this.replyContent.trim(),
                            parentId
                        );

                        if (response.success && response.data) {
                            // æ·»åŠ åˆ°è¯„è®ºåˆ—è¡¨
                            this.comments.push(response.data);
                            // æ¸…ç©ºè¾“å…¥æ¡†
                            this.replyContent = '';
                            this.replyTo = null;
                            // æ›´æ–°è¯„è®ºè®¡æ•°
                            this.article.comments_count++;
                        }
                    } catch (error) {
                        console.error('æäº¤å›å¤å¤±è´¥:', error);
                        await showAlert('æäº¤å›å¤å¤±è´¥: ' + error.message);
                    }
                },

                getChildComments(parentId) {
                    // æŸ¥æ‰¾æ‰€æœ‰ç›´æ¥æˆ–é—´æ¥å±äºè¯¥ä¸€çº§è¯„è®ºçš„äºŒçº§è¯„è®º
                    const getParentComment = (commentId) => {
                        const comment = this.comments.find(c => c.comment_id === commentId);
                        return comment ? (comment.parent_comment_id === 0 ? comment : getParentComment(comment.parent_comment_id)) : null;
                    };

                    // ç­›é€‰å‡ºæ‰€æœ‰å±äºå½“å‰ä¸€çº§è¯„è®ºçš„äºŒçº§è¯„è®º
                    const childComments = this.comments.filter(comment => {
                        if (comment.parent_comment_id === 0) return false; // æ’é™¤ä¸€çº§è¯„è®º
                        const rootComment = getParentComment(comment.parent_comment_id);
                        return rootComment && rootComment.comment_id === parentId;
                    });
                    // æŒ‰ç…§åˆ›å»ºæ—¶é—´æ’åºï¼Œæ—¶é—´è¶Šå¤§ï¼ˆè¶Šæ–°ï¼‰çš„è¯„è®ºå±•ç¤ºè¶Šé å‰
                    return childComments.sort((a, b) => b.created_at - a.created_at);
                },

                async toggleFeatured() {
                    // æ˜¾ç¤ºç¡®è®¤å¼¹çª—
                    const action = this.article.tag_ids.includes('108') ? 'å–æ¶ˆç²¾å' : 'åŠ ç²¾å';
                    if (!(await showConfirm(`ç¡®å®šè¦ã€${action}ã€‘è¿™ç¯‡æ–‡ç« å—ï¼Ÿ`))) {
                        return; // ç”¨æˆ·å–æ¶ˆæ“ä½œ
                    }

                    try {
                        const response = await apiService.toggleFeatured(this.slug);
                        if (response.success) {
                            // æ›´æ–°æœ¬åœ°æ–‡ç« çš„featured_weightå€¼
                            this.article.tag_ids.includes('108') ? this.article.tag_ids.replace('108', '') : this.article.tag_ids += '|108';
                            await showAlert(response.message);
                        }
                    } catch (error) {
                        console.error('æ“ä½œå¤±è´¥:', error);
                        await showAlert('æ“ä½œå¤±è´¥: ' + error.message);
                    }
                },

                // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ˜¯ç®¡ç†å‘˜
                isAdmin() {
                    return this.currentUser && (this.currentUser.role === 'admin' || this.currentUser.role === 'superadmin');
                },

                // åˆ é™¤è¯„è®º
                async deleteComment(commentId) {
                    // æ˜¾ç¤ºç¡®è®¤å¼¹çª—
                    if (!(await showConfirm('æ˜¯å¦åˆ é™¤è¯¥è®¨è®ºï¼Ÿ'))) {
                        return; // ç”¨æˆ·å–æ¶ˆæ“ä½œ
                    }

                    try {
                        const response = await apiService.deleteMyComment(commentId);
                        if (response.success) {
                            // ä»è¯„è®ºåˆ—è¡¨ä¸­ç§»é™¤è¯¥è¯„è®º
                            this.comments = this.comments.filter(comment => comment.comment_id !== commentId);
                            // æ›´æ–°è¯„è®ºè®¡æ•°
                            this.article.comments_count--;
                            await showAlert('åˆ é™¤æˆåŠŸï¼');
                        }
                    } catch (error) {
                        console.error('åˆ é™¤è¯„è®ºå¤±è´¥:', error);
                        await showAlert('åˆ é™¤è¯„è®ºå¤±è´¥: ' + error.message);
                    }
                },
            };
        }
    </script>

</body>

</html>