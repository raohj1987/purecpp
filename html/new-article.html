<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>创建新文章 - Purecpp.cn 现代C++社区</title>

    <link rel="stylesheet" href="css/pico.min.css">
    <link rel="stylesheet" href="font-awesome/css/all.min.css">
    <!-- PureCpp 统一样式 -->
    <link rel="stylesheet" href="css/purecpp.css">
    <script defer src="script/alpine.js"></script>

    <link rel="stylesheet" href="css/simplemde.min.css">
    <link rel="stylesheet" href="css/atom-one-dark.min.css">

    <style>
        /* 确保页脚始终在底部 */
        body {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        main {
            flex: 1;
        }

        /* 编辑器卡片 */
        .editor-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
        }

        /* 标题样式 */
        .editor-card h2 {
            color: var(--text-highlight);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
            margin-bottom: 0.6rem;
            font-size: 1.8rem;
        }

        /* 调整文章标题输入框的高度 */
        #article-title {
            height: 46px !important;
            padding-top: 0 !important;
            padding-bottom: 0 !important;
            line-height: 40px !important;
            padding-left: 0.8rem !important;
            padding-right: 0.8rem !important;
        }

        /* Markdown 编辑器区域 */
        #markdown-content {
            min-height: 600px;
            font-family: monospace;
            font-size: 0.95rem;
        }

        /* 摘要区域 */
        #article-excerpt {
            min-height: 100px;
            resize: vertical;
        }

        /* 下拉框和按钮组 */
        .control-group {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .control-group button {
            white-space: nowrap !important;
            width: auto !important;
            padding-left: 1rem;
            padding-right: 1rem;
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
            display: inline-block !important;
        }

        /* 自定义下拉样式 */
        .dropdown {
            position: relative;
            display: inline-block;
            width: 600px;
        }
    </style>
</head>

<body>
    <!-- 统一页头占位符 -->
    <div id="header-container"></div>

    <main class="page-wrapper">
        <article class="editor-card" x-data="articleEditorComponent()">
            <h2><i class="fas fa-pen-nib"></i> 撰写新文章</h2>

            <form action="/api/v1/new_article" method="POST" accept-charset="UTF-8" @submit="handleSubmit">
                <label for="article-title">文章标题</label>
                <input type="text" id="article-title" name="title" x-model="title" placeholder="请输入文章标题" required
                    maxlength="100">

                <label for="article-excerpt">文章摘要 (Excerpt)</label>
                <textarea id="article-excerpt" name="excerpt" x-model="excerpt" rows="3"
                    placeholder="请输入文章摘要，用于列表页展示 (建议100-200字)" maxlength="500"></textarea>

                <label for="markdown-content">文章内容 (Markdown 格式)</label>
                <textarea id="markdown-editor" name="content" x-model="content"
                    placeholder="在这里使用 Markdown 格式撰写您的文章正文..."></textarea>
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <label for="tag-select" style="margin: 0; white-space: nowrap;">选择标签</label>
                    <!-- 新的多选组件 -->
                    <div class="dropdown" @click.outside="open = false" style="flex: 1;">
                        <!-- 触发按钮 -->
                        <button type="button" @click="open = !open"
                                style="width: 100%; text-align: left; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--bg-card); color: var(--text-main); padding: 0.5rem 0.8rem; height: 46px; box-sizing: border-box;">
                            <template x-if="selectedTags.length === 0"><span
                                    style="color: var(--muted-color);">请选择选项</span></template>
                            <template x-if="selectedTags && selectedTags.length > 0">
                                <span x-text="getSelectedTagNames()"></span>
                            </template>
                        </button>
                        <!-- 下拉菜单 -->
                        <div class="dropdown-menu" x-show="open" x-transition style="width: 100%;">
                            <template x-for="tag in filteredTags" :key="tag.tag_id">
                            <label>
                                <input type="checkbox" :value="tag.tag_id" @change="toggle(tag.tag_id)"
                                       :checked="selectedTags && selectedTags.includes(tag.tag_id)">
                                <span x-text="tag.name"></span>
                            </label>
                        </template>
                        </div>
                    </div>
                </div>
                <div class="control-group" style="margin-top: 1rem; display: flex; justify-content: center;">
                    <button type="submit" class="primary"><i class="fas fa-upload"></i> 提交文章 (待审核)</button>
                </div>

                <small
                    style="color: var(--muted-color); margin-top: 1rem; display: block;">提交后文章将进入审核流程，审核通过后才会正式发布。</small>
            </form>
        </article>
    </main>

    <!-- 统一页脚占位符 -->
    <div id="footer-container"></div>
    <!-- API服务脚本 -->
    <script src="script/api_service.js"></script>
    <!-- 统一布局脚本 -->
    <script src="script/layout.js"></script>

    <script src="script/simplemde.min.js"></script>

    <script src="script/highlight.min.js"></script>
    <script src="script/cpp.min.js"></script>

    <script src="script/marked.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async function () {
            // --- 1. 配置 marked.js 以使用 Highlight.js ---
            marked.setOptions({
                gfm: true,
                breaks: true,
                sanitize: false,

                // 核心：自定义代码块渲染函数
                highlight: function (code, lang) {
                    const language = hljs.getLanguage(lang) ? lang : 'plaintext';
                    return hljs.highlight(code, { language }).value;
                }
            });
        });

        function articleEditorComponent() {
            return {
                simplemde: null,
                title: '',
                excerpt: '',
                content: '',
                tags: [],
                filteredTags: [],
                isLoading: false,
                errorMessage: '',
                open: false,
                selectedTags: [],
                userInfo: null,
                init() {
                    console.log('init_call');
                    this.initializeSimpleMDE();
                    this.userInfo = apiService.getUserInfo();
                    this.fetchTags();
                    this.selectedTags = [];
                },

                toggle(tag_id) {
                    const index = this.selectedTags.indexOf(tag_id);
                    if (index === -1) {
                        this.selectedTags.push(tag_id);
                    } else {
                        this.selectedTags.splice(index, 1);
                    }
                },

                getSelectedTagNames() {
                    if (!this.selectedTags) {
                        return '';
                    }
                    return this.selectedTags.map(tagId => {
                        const tag = this.tags.find(t => t.tag_id === tagId);
                        return tag ? tag.name : tagId;
                    }).join(', ');
                },

                async fetchTags() {
                    this.isLoading = true;
                    this.errorMessage = '';
                    try {
                        // 使用apiService获取标签列表
                        const response = await apiService.getTags();
                        this.tags = response.data;
                        this.filterTags();
                    } catch (error) {
                        console.error('获取标签失败:', error);
                        this.errorMessage = '无法加载标签数据，请稍后重试。';
                        this.isLoading = false;
                    }
                },

                filterTags() {
                    // 检查用户是否为管理员
                    const isAdmin = this.userInfo && (this.userInfo.role === 'admin' || this.userInfo.role === 'superadmin');

                    if (isAdmin) {
                        // 管理员可以看到所有标签
                        this.filteredTags = this.tags.filter(tag => tag.tag_id !== 108);
                    } else {
                        // 非管理员只能看到tag_group不为2的标签
                        this.filteredTags = this.tags.filter(tag => tag.tag_group !== 2).filter(tag => tag.tag_id !== 108);
                    }
                },

                initializeSimpleMDE() {
                    // --- 实例化 SimpleMDE ---
                    this.simplemde = new SimpleMDE({
                        element: document.getElementById("markdown-editor"),
                        spellChecker: false,

                        // 覆盖默认的预览渲染函数
                        previewRender: function (plainText, preview) {
                            return marked.parse(plainText);
                        },
                    });

                    // 监听编辑器的 change 事件，同步数据到 Alpine 的 content 变量
                    this.simplemde.codemirror.on("change", () => {
                        this.content = this.simplemde.value();
                    });

                    // 监听粘贴事件
                    this.simplemde.codemirror.on("paste", (cm, event) => {
                        this.handlePaste(event);
                    });
                },

                async handleSubmit(event) {
                    event.preventDefault(); // 阻止原生提交

                    if (this.selectedTags.length === 0) {
                        await showAlert('请至少选择一个文章标签');
                        return;
                    }

                    const content = this.simplemde.value()

                    if (!content || content.trim() === '') {
                        await showAlert('文章内容不能为空！');
                        return;
                    }

                    try {
                        // 将选中的标签ID数组转换为以|分隔的字符串
                        const tagIds = this.selectedTags.join('|');
                        const response = await apiService.createArticle(this.title, this.excerpt, this.content, tagIds);
                        await showAlert('文章提交成功！请等待审核。');
                        window.location.href = '/articles.html';
                    } catch (error) {
                        console.error('Submit error:', error);
                        this.errorMessage = '提交失败：' + error.message;
                        await showAlert(this.errorMessage);
                    }
                },

                // 处理粘贴事件
                async handlePaste(event) {
                    const items = event.clipboardData?.items;
                    if (!items) return;

                    for (let i = 0; i < items.length; i++) {
                        const file = items[i].getAsFile();
                        if (file) {
                            event.preventDefault(); // 阻止默认粘贴行为
                            await this.uploadPastedFile(file);
                        }
                    }
                },
                async  generateQuarterWidthImageMarkdown(file, url) {
                // 宽度设为容器宽度的35%
                return `<img src="${url}" 
                        alt="${file.name}" 
                        style="width: 35%; height: auto; display: block; margin: 10px auto;"
                        >`;
                },
                // 上传粘贴的文件
                async uploadPastedFile(file) {
                    try {
                        if (file.size > 4 * 1024 * 1024) {
                            this.showMessage('图片大小不能超过4MB', true);
                            return;
                        }
                        const userInfo = this.userInfo || apiService.getUserInfo();
                        const response = await apiService.uploadFile(userInfo.id, file);

                        if (response.success && response.data) {
                            // 获取当前光标位置
                            const cursor = this.simplemde.codemirror.getCursor();
                            
                            // 根据文件类型生成不同的Markdown格式
                            let markdownFormat = '';
                            if (file.type.indexOf('image') !== -1) {
                                // 图片文件
                                markdownFormat = `<img src="${response.data.url}" style="width: 25%; height: auto; display: block; margin: 10px auto;">`;
                            } else {
                                // 其他文件
                                markdownFormat = `[${file.name}](${response.data.url})`;
                            }

                            // 在光标位置插入Markdown
                            this.simplemde.codemirror.replaceRange(markdownFormat, cursor);

                            await showAlert('文件粘贴上传成功！');
                        } else {
                            await showAlert('文件粘贴上传失败：' + (response.message || '未知错误'));
                        }
                    } catch (error) {
                        console.error('文件粘贴上传失败:', error);
                        await showAlert('文件粘贴上传失败：' + error.message);
                    }
                }
            }
        }
    </script>
</body>

</html>