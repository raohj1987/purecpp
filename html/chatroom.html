<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>èŠå¤©å®¤ - PureCpp</title>
    <link rel="stylesheet" href="css/pico.min.css">
    <link rel="stylesheet" href="font-awesome/css/all.min.css">
    <link rel="stylesheet" href="css/simplemde.min.css">
    <link rel="stylesheet" href="css/atom-one-dark.min.css">

    <script defer src="script/alpine.js"></script>
    <style>
        :root {
            --primary: #4f46e5;
            --primary-hover: #4338ca;
            --border-color: #e2e8f0;
            --muted-color: #6b7280;
            --bg-page: #ffffff;
            --bg-card: #ffffff;
            --text-main: #333;
            --text-highlight: var(--primary);

            --primary-color: #4a154b;
            --secondary-color: #350d36;
            --accent-color: #1177aa;
            --message-bg: #ffffff;
            --own-message-bg: #e8f5e8;
            --sidebar-bg: #f8f9fa;
            --mention-badge: #ec0b43;
        }
        
        body {
            margin: 0;
            overflow-x: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }
        
        .page-wrapper {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        
        .chat-container {
            display: flex;
            flex: 1;
            min-height: 0;
        }
        
        /* å·¦ä¾§è¾¹æ  */
        .sidebar {
            width: 260px;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }
        
        .team-header {
            padding: 20px 16px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            font-weight: bold;
            font-size: 18px;
            display: flex;
            align-items: center;
        }
        
        .team-header i {
            margin-right: 10px;
        }
        
        .user-profile {
            padding: 16px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
        }
        
        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 4px;
            background-color: #5d275d;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-weight: bold;
        }
        
        .user-name {
            font-weight: bold;
            color: white;
        }
        
        .user-status {
            font-size: 12px;
            color: #ccc;
        }
        
        .channels-section, .direct-messages-section {
            padding: 16px 0;
        }
        
        .section-header {
            padding: 0 16px;
            font-weight: bold;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .section-header-text {
            color: white;
        }
        
        .add-channel {
            background: transparent;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 16px;
        }
        
        .channel-list, .user-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .channel-item, .user-item {
            padding: 8px 16px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: background 0.2s;
            position: relative;
        }
        
        .channel-item:hover, .user-item:hover {
            background-color: rgba(255,255,255,0.1);
        }
        
        .channel-item.active {
            background-color: rgba(255,255,255,0.15);
            font-weight: bold;
        }
        
        .channel-item i, .user-item i {
            margin-right: 8px;
            width: 20px;
            text-align: center;
            color: white;
        }
        
        .channel-item-text, .user-item-text {
            color: white;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-size: 16px;
        }
        
        .user-item {
            position: relative;
        }
        
        .mention-badge {
            position: absolute;
            right: 16px;
            background-color: var(--mention-badge);
            color: white;
            border-radius: 10px;
            font-size: 12px;
            min-width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 4px;
        }
        
        /* ä¸»èŠå¤©åŒºåŸŸ */
        .main-chat {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: white;
        }
        
        .chat-header {
            padding: 0 20px;
            height: 60px;
            border-bottom: 1px solid #e8e8e8;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .channel-info {
            display: flex;
            align-items: center;
        }
        
        .channel-name {
            font-weight: bold;
            font-size: 18px;
        }
        
        .channel-topic {
            margin-left: 15px;
            color: #666;
            font-size: 14px;
        }
        
        .chat-content {
            flex: 1;
            display: flex;
            min-height: 0;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background-color: var(--sidebar-bg);
            max-height: calc(100vh - 200px); /* æ˜¾å¼è®¾ç½®æœ€å¤§é«˜åº¦ */
            min-height: 0; /* ç¡®ä¿flexå­å…ƒç´ æ­£ç¡®è®¡ç®—é«˜åº¦ */
            scrollbar-width: thin; /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ï¼ˆå¯é€‰ï¼‰ */
            scrollbar-color: #ccc #f1f1f1; /* è‡ªå®šä¹‰æ»šåŠ¨æ¡é¢œè‰²ï¼ˆå¯é€‰ï¼‰ */
        }

        /* ä¸ºWebKitæµè§ˆå™¨ï¼ˆChrome, Safariç­‰ï¼‰æ·»åŠ æ»šåŠ¨æ¡æ ·å¼ */
        .chat-messages::-webkit-scrollbar {
            width: 6px; /* æ»šåŠ¨æ¡å®½åº¦ */
        }

        .chat-messages::-webkit-scrollbar-track {
            background: #f1f1f1; /* æ»šåŠ¨æ¡èƒŒæ™¯ */
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: #ccc; /* æ»šåŠ¨æ¡æ»‘å— */
            border-radius: 3px; /* æ»šåŠ¨æ¡æ»‘å—åœ†è§’ */
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: #aaa; /* æ»šåŠ¨æ¡æ»‘å—æ‚¬åœé¢œè‰² */
        }
        
        .channel-users {
            width: 220px;
            background-color: white;
            border-left: 1px solid #e8e8e8;
            display: flex;
            flex-direction: column;
        }
        
        .channel-users-header {
            padding: 12px 16px;
            border-bottom: 1px solid #e8e8e8;
            font-weight: bold;
            font-size: 14px;
            color: #333;
        }
        
        .channel-users-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px 0;
        }
        
        .channel-user-item {
            padding: 8px 16px;
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        
        .channel-user-item:hover {
            background-color: #f5f5f5;
        }
        
        .channel-user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 4px;
            background-color: #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-weight: bold;
            font-size: 14px;
        }
        
        .channel-user-name {
            font-size: 14px;
            color: #333;
        }

        .channel-action {
    background: transparent;
    border: none;
    color: white;
    cursor: pointer;
    font-size: 16px; /* å‡å°å­—ä½“å¤§å° */
    width: 20px; /* è®¾ç½®å›ºå®šå®½åº¦ */
    height: 20px; /* è®¾ç½®å›ºå®šé«˜åº¦ */
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 3px; /* æ·»åŠ åœ†è§’ */
    margin-left: 5px; /* è°ƒæ•´ä¸é¢‘é“åç§°çš„é—´è· */
}

.channel-action:hover {
    background-color: rgba(255, 255, 255, 0.2); /* æ‚¬åœæ•ˆæœ */
}
        
        .message {
            display: flex;
            margin-bottom: 16px;
            padding: 8px 12px;
            border-radius: 6px;
            background-color: var(--message-bg);
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        
        .message.own-message {
            background-color: var(--own-message-bg);
        }
        
        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 4px;
            background-color: #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            flex-shrink: 0;
            font-weight: bold;
        }
        
        .message-content {
            flex: 1;
        }
        
        .message-header {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
        }
        
        .message-user {
            font-weight: bold;
            margin-right: 8px;
            font-size: 16px;
        }
        
        .message-time {
            color: #999;
            font-size: 12px;
        }
        
        .message-text {
            line-height: 1.4;
            margin-bottom: 8px;
            font-size: 16px;
        }
        
        .message-text .mention {
            background-color: #ffeaea;
            color: #c00;
            padding: 1px 4px;
            border-radius: 3px;
            font-weight: bold;
        }

        /* æ·»åŠ åˆ°CSSæ ·å¼è¡¨ä¸­çš„.message-textéƒ¨åˆ† */
        .message-text .mention-self {
            background-color: #e1f7d9; /* æµ…ç»¿è‰²èƒŒæ™¯ */
            color: #2e7d32; /* æ·±ç»¿è‰²æ–‡å­— */
            padding: 1px 4px;
            border-radius: 3px;
            font-weight: bold;
        }

        .message-text .mention-other {
            background-color: #fff9c4; /* æµ…é»„è‰²èƒŒæ™¯ */
            color: #f57c00; /* æ©™è‰²æ–‡å­— */
            padding: 1px 4px;
            border-radius: 3px;
            font-weight: bold;
        }
        
        .message-actions {
            display: flex;
            gap: 10px;
        }
        
        .message-action {
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 3px;
        }
        
        .message-action:hover {
            background-color: #f0f0f0;
        }
        
        .emoji-reaction {
            background-color: #f0f0f0;
            border-radius: 10px;
            padding: 2px 8px;
            font-size: 12px;
            margin-right: 5px;
            display: inline-flex;
            align-items: center;
            cursor: pointer;
        }
        
        .emoji-reaction:hover {
            background-color: #e0e0e0;
        }
        
        .emoji-reaction i {
            margin-right: 4px;
        }
        
        .load-more {
            text-align: center;
            padding: 10px;
            color: var(--accent-color);
            cursor: pointer;
            font-weight: bold;
        }
        
        /* è¾“å…¥åŒºåŸŸ */
        .chat-input-container {
            padding: 20px;
            border-top: 1px solid #e8e8e8;
            background-color: white;
        }
        
        .chat-input-wrapper {
            position: relative;
        }
        
        .chat-input {
            width: 100%;
            min-height: 100px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-family: inherit;
            font-size: 15px;
            resize: none;
            box-sizing: border-box;
        }
        
        .chat-input:focus {
            outline: none;
            border-color: var(--accent-color);
        }
        
        .input-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
        }
        
        .action-button {
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            font-size: 18px;
            width: 36px;
            height: 36px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .action-button:hover {
            background-color: #f0f0f0;
        }
        
        .send-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 20px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .send-button:hover {
            background-color: var(--secondary-color);
        }
        
        /* ç”¨æˆ·å»ºè®®ä¸‹æ‹‰æ¡† */
        .user-suggestions {
            position: absolute;
            bottom: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px 6px 0 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            max-height: 200px;
            overflow-y: auto;
            display: none;
            z-index: 100;
        }
        
        .user-suggestion {
            padding: 10px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
        }
        
        .user-suggestion:hover {
            background-color: #f5f5f5;
        }
        
        .user-suggestion.active {
            background-color: #e8f0fe;
        }

        /* è¡¨æƒ…é€‰æ‹©å™¨æ ·å¼ */
.reaction-picker {
    position: relative;
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    padding: 10px;
    display: none;
    grid-template-columns: repeat(6, 1fr);
    gap: 8px;
    z-index: 1000;
    max-width: 250px;
}

.reaction-emoji {
    font-size: 20px;
    cursor: pointer;
    text-align: center;
    padding: 5px;
    border-radius: 4px;
    transition: all 0.2s;
}

.reaction-emoji:hover {
    background-color: #f0f0f0;
    transform: scale(1.2);
}
        
        /* è¡¨æƒ…é€‰æ‹©å™¨ */
        .emoji-picker {
            position: relative;
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            width: 300px;
            padding: 10px;
            display: none;
            grid-template-columns: repeat(8, 1fr);
            gap: 5px;
            z-index: 100;
        }
        
        .emoji-item {
            font-size: 20px;
            cursor: pointer;
            text-align: center;
            padding: 5px;
            border-radius: 4px;
        }
        
        .emoji-item:hover {
            background-color: #f0f0f0;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .sidebar {
                width: 70px;
            }
            
            .sidebar .user-item-text,
            .sidebar .channel-item-text,
            .sidebar .section-header-text,
            .sidebar .user-name,
            .sidebar .user-status {
                display: none;
            }
            
            .section-header {
                justify-content: center;
            }
            
            .user-profile {
                justify-content: center;
            }
            
            .user-avatar {
                margin-right: 0;
            }
            
            .mention-badge {
                right: 5px;
            }
            
            .channel-users {
                width: 60px;
            }
            
            .channel-users-header,
            .channel-user-name {
                display: none;
            }
            
            .channel-user-avatar {
                margin-right: 0;
            }
        }
    </style>
</head>
<body>
    <div class="page-wrapper">
        <div id="header-container"></div>
    <div class="chat-container">
        <!-- å·¦ä¾§è¾¹æ  -->
        <div class="sidebar">
            <div class="team-header">
                <i class="fas fa-code"></i>
                <span class="section-header-text">PureCpp ç¤¾åŒº</span>
            </div>
            
            <div class="user-profile">
                <div class="user-avatar" style="background-color: #4a6fa5;">Y</div>
                <div class="user-info">
                    <div class="user-name">You (æ‚¨)</div>
                    <div class="user-status">åœ¨çº¿</div>
                </div>
            </div>
            
            <div class="channels-section">
                <div class="section-header">
                    <span class="section-header-text">é¢‘é“</span>
                    <button class="add-channel" id="add-channel-btn" title="åˆ›å»ºæ–°é¢‘é“">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                <ul class="channel-list" id="channel-list">
                    <!-- é¢‘é“å°†é€šè¿‡JSåŠ¨æ€æ·»åŠ  -->
                </ul>
            </div>
            
            <div class="direct-messages-section">
                <div class="section-header">
                    <span class="section-header-text">åœ¨çº¿æˆå‘˜</span>
                </div>
                <ul class="user-list" id="user-list">
                    <!-- ç”¨æˆ·å°†é€šè¿‡JSåŠ¨æ€æ·»åŠ  -->
                </ul>
            </div>
        </div>
        
        <!-- ä¸»èŠå¤©åŒºåŸŸ -->
        <div class="main-chat">
            <div class="chat-header">
                <div class="channel-info">
                    <div class="channel-name" id="current-channel-name"># é€šç”¨èŠå¤©</div>
                    <div class="channel-topic" id="current-channel-topic">æ¬¢è¿æ¥åˆ°PureCppç¤¾åŒºèŠå¤©å®¤ï¼</div>
                </div>
            </div>
            
            <div class="chat-content">
                <div class="chat-messages" id="chat-messages">
                    <!-- æ¶ˆæ¯å°†é€šè¿‡JSåŠ¨æ€æ·»åŠ  -->
                </div>
                
                <!-- å³ä¾§åœ¨çº¿ç”¨æˆ·åˆ—è¡¨ -->
                <div class="channel-users">
                    <div class="channel-users-header">
                        <i class="fas fa-users"></i> åœ¨çº¿æˆå‘˜
                    </div>
                    <div class="channel-users-list" id="channel-users-list">
                        <!-- å½“å‰é¢‘é“çš„åœ¨çº¿ç”¨æˆ·å°†é€šè¿‡JSåŠ¨æ€æ·»åŠ  -->
                    </div>
                </div>
            </div>
            
            <div class="chat-input-container">
                <div class="chat-input-wrapper">
                    <textarea class="chat-input" id="chat-input" placeholder="è¾“å…¥æ¶ˆæ¯... ä½¿ç”¨@æåŠç”¨æˆ·"></textarea>
                    <div class="user-suggestions" id="user-suggestions"></div>
                    <div class="emoji-picker" id="emoji-picker"></div>
                </div>
                <div class="input-actions">
                    <div class="action-buttons">
                        <button class="action-button" id="emoji-btn" title="è¡¨æƒ…">
                            <i class="far fa-smile"></i>
                        </button>
                        <button class="action-button" id="image-btn" title="ä¸Šä¼ å›¾ç‰‡">
                            <i class="fas fa-image"></i>
                        </button>
                    </div>
                    <button class="send-button" id="send-btn">å‘é€</button>
                </div>
            </div>
        </div>
    </div>
    <div id="footer-container"></div>
    </div>
    <script src="script/layout.js"></script>

    <script>
        // åˆå§‹åŒ–æ•°æ®
        const initialUsers = [
            { id: 1, name: "You (æ‚¨)", avatar: "Y", color: "#4a6fa5", online: true, mentions: 0, joinedChannels: [1, 2] },
            { id: 2, name: "Alex Johnson", avatar: "A", color: "#d1453b", online: true, mentions: 0, joinedChannels: [1, 2] },
            { id: 3, name: "Sam Wilson", avatar: "S", color: "#2e8540", online: true, mentions: 0, joinedChannels: [1, 2] },
            { id: 4, name: "Taylor Smith", avatar: "T", color: "#6f42c1", online: false, mentions: 0, joinedChannels: [1] },
            { id: 5, name: "Jordan Lee", avatar: "J", color: "#e36209", online: true, mentions: 0, joinedChannels: [1, 2] },
            { id: 6, name: "Chris Brown", avatar: "C", color: "#0086b3", online: true, mentions: 0, joinedChannels: [1, 3] },
            { id: 7, name: "Casey Miller", avatar: "C", color: "#795548", online: false, mentions: 0, joinedChannels: [1] }
        ];
        
        const initialChannels = [
            { id: 1, name: "é€šç”¨èŠå¤©", topic: "æ¬¢è¿æ¥åˆ°PureCpp ç¤¾åŒºèŠå¤©å®¤ï¼", unread: 0, joined: true },
            { id: 2, name: "é¡¹ç›®è®¨è®º", topic: "è®¨è®ºé¡¹ç›®ç›¸å…³äº‹å®œ", unread: 3, joined: true },
            { id: 3, name: "æŠ€æœ¯é—®é¢˜", topic: "æŠ€æœ¯é—®é¢˜æ±‚åŠ©ä¸è§£ç­”", unread: 0, joined: false },
            { id: 4, name: "å†…éƒ¨æµ‹è¯•", topic: "ä»…ä¾›æµ‹è¯•ä½¿ç”¨", unread: 0, joined: false } // æ–°å¢ä¸€ä¸ªæœªåŠ å…¥çš„é¢‘é“
        ];
        
        // åˆå§‹æ¶ˆæ¯
        const initialMessages = {
            1: [
                { id: 1, userId: 2, userName: "Alex Johnson", text: "å¤§å®¶å¥½ï¼æ¬¢è¿æ¥åˆ°PureCppèŠå¤©å®¤ï¼", time: "09:30", reactions: [] },
                { id: 2, userId: 3, userName: "Sam Wilson", text: "å—¨ @You (æ‚¨)ï¼Œä»Šå¤©ä»£ç å®¡æ ¸å®Œæˆäº†å—ï¼Ÿ", time: "09:32", reactions: [{emoji: "ğŸ‘", count: 2}] },
                { id: 3, userId: 1, userName: "You (æ‚¨)", text: "è¿˜æ²¡å‘¢ï¼Œ@Sam Wilsonã€‚å¤§æ¦‚è¿˜éœ€è¦ä¸€ä¸ªå°æ—¶ã€‚", time: "09:35", reactions: [] },
                { id: 4, userId: 5, userName: "Jordan Lee", text: "æœ‰äººçœ‹è¿‡æœ€æ–°æäº¤çš„PRå—ï¼Ÿ", time: "09:40", reactions: [] },
                { id: 5, userId: 2, userName: "Alex Johnson", text: "æˆ‘åˆšçœ‹äº†ï¼Œ@Jordan Leeã€‚æœ‰ä¸€äº›å°é—®é¢˜éœ€è¦ä¿®æ”¹ã€‚", time: "09:42", reactions: [{emoji: "ğŸ‘€", count: 1}] },
                { id: 6, userId: 3, userName: "Sam Wilson", text: "æˆ‘ä¸Šä¼ äº†æ–°çš„è®¾è®¡å›¾ï¼Œè¯·å¤§å®¶çœ‹ä¸€ä¸‹ï¼šhttps://example.com/design.png", time: "10:15", reactions: [] },
                { id: 7, userId: 5, userName: "Jordan Lee", text: "çœ‹èµ·æ¥ä¸é”™ï¼", time: "10:20", reactions: [{emoji: "â¤ï¸", count: 3}] },
                { id: 8, userId: 1, userName: "You (æ‚¨)", text: "æˆ‘åŒæ„ @Jordan Leeï¼Œè®¾è®¡å¾ˆå¥½ã€‚@Alex Johnson ä½ è§‰å¾—å‘¢ï¼Ÿ", time: "10:22", reactions: [] },
                { id: 9, userId: 2, userName: "Alex Johnson", text: "æˆ‘ä¹Ÿå–œæ¬¢è¿™ä¸ªè®¾è®¡ã€‚ä¸è¿‡æˆ‘ä»¬éœ€è¦è€ƒè™‘å“åº”å¼å¸ƒå±€ã€‚", time: "10:25", reactions: [] },
                { id: 10, userId: 3, userName: "Sam Wilson", text: "å¥½å»ºè®®ï¼Œæˆ‘ä¼šè°ƒæ•´çš„ã€‚", time: "10:30", reactions: [{emoji: "âœ…", count: 1}] },
                { id: 11, userId: 6, userName: "Chris Brown", text: "æ—©ä¸Šå¥½å„ä½ï¼ä»Šå¤©ä¼šè®®æ˜¯ä¸‹åˆ3ç‚¹å—ï¼Ÿ", time: "10:35", reactions: [] },
                { id: 12, userId: 1, userName: "You (æ‚¨)", text: "æ˜¯çš„ @Chris Brownï¼Œä¸‹åˆ3ç‚¹åœ¨3å·ä¼šè®®å®¤ã€‚", time: "10:37", reactions: [] },
                { id: 13, userId: 3, userName: "Sam Wilson", text: "@You (æ‚¨) åˆ«å¿˜äº†æ£€æŸ¥æˆ‘åˆšå‘çš„PRï¼", time: "10:40", reactions: [] },
                { id: 14, userId: 5, userName: "Jordan Lee", text: "æˆ‘åˆšä¿®å¤äº†é‚£ä¸ªbugï¼Œå¯ä»¥æµ‹è¯•äº†ã€‚", time: "10:45", reactions: [] },
                { id: 15, userId: 2, userName: "Alex Johnson", text: "å¥½çš„ï¼Œæˆ‘æ¥æµ‹è¯•ä¸€ä¸‹ã€‚", time: "10:47", reactions: [] }
            ],
            2: [
                { id: 16, userId: 5, userName: "Jordan Lee", text: "ä¸‹ä¸€ä¸ªsprintçš„è®¡åˆ’å¤§å®¶æœ‰ä»€ä¹ˆæƒ³æ³•ï¼Ÿ", time: "æ˜¨å¤© 14:20", reactions: [] },
                { id: 17, userId: 2, userName: "Alex Johnson", text: "æˆ‘è®¤ä¸ºåº”è¯¥å…ˆå®Œæˆç”¨æˆ·è®¤è¯æ¨¡å—ã€‚@You (æ‚¨) ä½ è§‰å¾—å‘¢ï¼Ÿ", time: "æ˜¨å¤© 14:35", reactions: [] },
                { id: 18, userId: 1, userName: "You (æ‚¨)", text: "åŒæ„ï¼Œè®¤è¯æ¨¡å—ä¼˜å…ˆçº§åº”è¯¥æœ€é«˜ã€‚", time: "æ˜¨å¤© 14:40", reactions: [] }
            ],
            3: [
                { id: 19, userId: 3, userName: "Sam Wilson", text: "æœ‰äººé‡åˆ°è¿‡è¿™ä¸ªç¼–è¯‘é”™è¯¯å—ï¼Ÿ", time: "æ˜¨å¤© 11:10", reactions: [] },
                { id: 20, userId: 1, userName: "You (æ‚¨)", text: "@Sam Wilson æˆ‘é‡åˆ°è¿‡ï¼Œä½ éœ€è¦æ›´æ–°ä¾èµ–åº“ç‰ˆæœ¬ã€‚", time: "æ˜¨å¤© 11:15", reactions: [{emoji: "ğŸ’¡", count: 1}] }
            ]
        };
        
        // å¸¸ç”¨è¡¨æƒ…
        const commonEmojis = ["ğŸ˜€", "ğŸ˜", "ğŸ˜‚", "ğŸ¤£", "ğŸ˜ƒ", "ğŸ˜„", "ğŸ˜…", "ğŸ˜†", "ğŸ˜‰", "ğŸ˜Š", "ğŸ˜‹", "ğŸ˜", "ğŸ˜", "ğŸ˜˜", "ğŸ¥°", "ğŸ˜—", "ğŸ˜™", "ğŸ˜š", "ğŸ™‚", "ğŸ¤—", "ğŸ¤©", "ğŸ¤”", "ğŸ˜", "ğŸ˜‘", "ğŸ˜¶", "ğŸ™„", "ğŸ˜", "ğŸ˜£", "ğŸ˜¥", "ğŸ˜®", "ğŸ¤", "ğŸ˜¯", "ğŸ˜ª", "ğŸ˜«", "ğŸ¥±", "ğŸ˜´", "ğŸ˜Œ", "ğŸ˜›", "ğŸ˜œ", "ğŸ˜", "ğŸ¤¤", "ğŸ˜’", "ğŸ˜“", "ğŸ˜”", "ğŸ˜•", "ğŸ™ƒ", "ğŸ¤‘", "ğŸ˜²", "â˜¹ï¸", "ğŸ™", "ğŸ˜–", "ğŸ˜", "ğŸ˜Ÿ", "ğŸ˜¤", "ğŸ˜¢", "ğŸ˜­", "ğŸ˜¦", "ğŸ˜§", "ğŸ˜¨", "ğŸ˜©", "ğŸ¤¯", "ğŸ˜¬", "ğŸ˜°", "ğŸ˜±", "ğŸ¥µ", "ğŸ¥¶", "ğŸ˜³", "ğŸ¤ª", "ğŸ˜µ", "ğŸ˜ ", "ğŸ˜¡", "ğŸ¤¬", "ğŸ˜·", "ğŸ¤’", "ğŸ¤•", "ğŸ¤¢", "ğŸ¤®", "ğŸ¤§", "ğŸ˜‡", "ğŸ¥³", "ğŸ¥º", "ğŸ¤ ", "ğŸ¤¡", "ğŸ¤¥", "ğŸ¤«", "ğŸ¤­", "ğŸ§", "ğŸ¤“", "ğŸ’©", "ğŸ‘", "ğŸ‘", "ğŸ‘€", "â¤ï¸", "ğŸ”¥", "ğŸ‰", "ğŸš€", "ğŸ’¡"];
        
        // åº”ç”¨çŠ¶æ€
        let currentUser = initialUsers[0];
        let currentChannelId = 1;
        let users = [...initialUsers];
        let channels = [...initialChannels];
        let messages = JSON.parse(JSON.stringify(initialMessages)); // æ·±åº¦å¤åˆ¶
        let messageLoadCount = 12;
        
        // DOMå…ƒç´ 
        const channelList = document.getElementById('channel-list');
        const userList = document.getElementById('user-list');
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const sendBtn = document.getElementById('send-btn');
        const emojiBtn = document.getElementById('emoji-btn');
        const imageBtn = document.getElementById('image-btn');
        const emojiPicker = document.getElementById('emoji-picker');
        const userSuggestions = document.getElementById('user-suggestions');
        const currentChannelName = document.getElementById('current-channel-name');
        const currentChannelTopic = document.getElementById('current-channel-topic');
        const addChannelBtn = document.getElementById('add-channel-btn');
        const channelUsersList = document.getElementById('channel-users-list');
        
        // åˆå§‹åŒ–åº”ç”¨
        function initApp() {
            // è®¡ç®—åˆå§‹çš„@æåŠæ•°é‡
            calculateInitialMentions();
            
            renderChannels();
            renderUsers();
            renderChannelUsers();
            renderMessages();
            
            // è®¾ç½®å½“å‰é¢‘é“ä¿¡æ¯
            const currentChannel = channels.find(c => c.id === currentChannelId);
            currentChannelName.textContent = `# ${currentChannel.name}`;
            currentChannelTopic.textContent = currentChannel.topic;
            
            // äº‹ä»¶ç›‘å¬
            setupEventListeners();
        }
        
        // è®¡ç®—åˆå§‹çš„@æåŠæ•°é‡
        function calculateInitialMentions() {
            // éå†æ‰€æœ‰æ¶ˆæ¯ï¼ŒæŸ¥æ‰¾@å½“å‰ç”¨æˆ·çš„æ¶ˆæ¯
            Object.values(messages).forEach(channelMessages => {
                channelMessages.forEach(msg => {
                    // æ£€æŸ¥æ¶ˆæ¯ä¸­æ˜¯å¦@äº†å½“å‰ç”¨æˆ·
                    const mentionRegex = /@You\s*\(\s*æ‚¨\s*\)|@You/g;
                    if (mentionRegex.test(msg.text) && msg.userId !== currentUser.id) {
                        currentUser.mentions++;
                    }
                });
            });
        }
        
        // æ¸²æŸ“é¢‘é“åˆ—è¡¨
        function renderChannels() {
            channelList.innerHTML = '';

            channels.forEach(channel => {
                const li = document.createElement('li');
                li.className = `channel-item ${channel.id === currentChannelId ? 'active' : ''}`;
                li.dataset.channelId = channel.id;

                let actionBtn = '';
                if (channel.joined) {
                    actionBtn = `<button class="channel-action" data-action="leave" data-channel-id="${channel.id}">Ã—</button>`;
                } else {
                    actionBtn = `<button class="channel-action" data-action="join" data-channel-id="${channel.id}">+</button>`;
                }

                li.innerHTML = `
                    <i class="fas fa-hashtag"></i>
                    <span class="channel-item-text">${channel.name}</span>
                    ${channel.unread > 0 && channel.joined ? `<span class="mention-badge">${channel.unread}</span>` : ''}
                    ${actionBtn}
                `;

                li.addEventListener('click', (e) => {
                    if (e.target.classList.contains('channel-action')) return; // ä¸è§¦å‘åˆ‡æ¢
                    switchChannel(channel.id);
                });

                channelList.appendChild(li);
            });
        }
        
        // æ¸²æŸ“ç”¨æˆ·åˆ—è¡¨
        function renderUsers() {
            userList.innerHTML = '';
            
            // æ˜¾ç¤ºæ‰€æœ‰åœ¨çº¿ç”¨æˆ·ï¼ˆåŒ…æ‹¬è‡ªå·±ï¼‰
            const onlineUsers = users.filter(user => user.online);
            
            onlineUsers.forEach(user => {
                const li = document.createElement('li');
                li.className = 'user-item';
                li.dataset.userId = user.id;
                
                // å¦‚æœæ˜¯å½“å‰ç”¨æˆ·ï¼Œæ˜¾ç¤ºç‰¹æ®Šçš„@æåŠæ•°é‡
                const mentionCount = user.id === currentUser.id ? user.mentions : 0;
                
                li.innerHTML = `
                    <div class="user-avatar" style="background-color: ${user.color};">${user.avatar}</div>
                    <div class="user-item-text">${user.name}</div>
                    ${mentionCount > 0 ? `<span class="mention-badge">${mentionCount}</span>` : ''}
                `;
                
                li.addEventListener('click', () => {
                    if (user.id === currentUser.id) {
                        // ç‚¹å‡»è‡ªå·±ï¼Œæ¸…é™¤@æåŠæ•°é‡
                        user.mentions = 0;
                        renderUsers();
                    } else {
                        startDirectMessage(user.id);
                    }
                });
                
                userList.appendChild(li);
            });
        }
        
        // æ¸²æŸ“å½“å‰é¢‘é“çš„åœ¨çº¿ç”¨æˆ·åˆ—è¡¨
        function renderChannelUsers() {
            channelUsersList.innerHTML = '';
            
            // åªæ˜¾ç¤ºå½“å‰é¢‘é“çš„åœ¨çº¿æˆå‘˜
            const currentChannelMembers = users.filter(user => 
                user.online && user.joinedChannels.includes(currentChannelId)
            );
            
            currentChannelMembers.forEach(user => {
                const div = document.createElement('div');
                div.className = 'channel-user-item';
                div.dataset.userId = user.id;
                
                div.innerHTML = `
                    <div class="channel-user-avatar" style="background-color: ${user.color};">${user.avatar}</div>
                    <div class="channel-user-name">${user.name}</div>
                `;
                
                div.addEventListener('click', () => {
                    if (user.id === currentUser.id) {
                        // ç‚¹å‡»è‡ªå·±ï¼Œæ¸…é™¤@æåŠæ•°é‡
                        user.mentions = 0;
                        renderUsers();
                    } else {
                        startDirectMessage(user.id);
                    }
                });
                
                channelUsersList.appendChild(div);
            });
        }

        // æ¸²æŸ“æ¶ˆæ¯
        function renderMessages() {
            chatMessages.innerHTML = '';
            
            const channelMessages = messages[currentChannelId] || [];
            const startIndex = Math.max(0, channelMessages.length - messageLoadCount);
            const messagesToShow = channelMessages.slice(startIndex);
            
            // æ·»åŠ "é˜…è¯»æ›´å¤šæ¶ˆæ¯"æŒ‰é’®ï¼ˆåœ¨é¡¶éƒ¨æ˜¾ç¤ºæ—§æ¶ˆæ¯ï¼‰
            if (startIndex > 0) {
                const loadMoreDiv = document.createElement('div');
                loadMoreDiv.className = 'load-more';
                // ä¿®æ”¹è®¡æ•°é€»è¾‘ï¼Œç¡®ä¿æ–°æ¶ˆæ¯ä¸å½±å“è®¡æ•°
                const remainingMessages = Math.max(0, channelMessages.length - messageLoadCount);
                loadMoreDiv.textContent = `é˜…è¯»æ›´å¤šæ¶ˆæ¯ (${remainingMessages} æ¡)`;
                loadMoreDiv.addEventListener('click', loadMoreMessages);
                chatMessages.appendChild(loadMoreDiv);
            }
            
            // æ¸²æŸ“æ¯æ¡æ¶ˆæ¯
            messagesToShow.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${msg.userId === currentUser.id ? 'own-message' : ''}`;
                
                const user = users.find(u => u.id === msg.userId);
                
                messageDiv.innerHTML = `
                    <div class="message-avatar" style="background-color: ${user?.color || '#ddd'};">${user?.avatar || '?'}</div>
                    <div class="message-content">
                        <div class="message-header">
                            <div class="message-user">${msg.userName}</div>
                            <div class="message-time">${msg.time}</div>
                        </div>
                        <div class="message-text">${formatMessageText(msg.text)}</div>
                        ${msg.reactions && msg.reactions.length > 0 ? 
                            `<div class="reactions-container">
                                ${msg.reactions.map(r => `
                                    <span class="emoji-reaction ${r.users && r.users.includes(currentUser.id) ? 'reacted' : ''}" 
                                        data-message-id="${msg.id}" 
                                        data-emoji="${r.emoji}">
                                        ${r.emoji} ${r.count}
                                    </span>
                                `).join('')}
                            </div>` : ''
                        }
                        <div class="message-actions">
                            <button class="message-action react-btn" data-message-id="${msg.id}">
                                <i class="far fa-smile"></i> è¡¨æƒ…
                            </button>
                            <button class="message-action" data-action="reply" data-message-id="${msg.id}">å›å¤</button>
                        </div>
                    </div>
                `;
                                        
                chatMessages.appendChild(messageDiv);
            });
            
            // æ»šåŠ¨åˆ°åº•éƒ¨ï¼ˆæœ€æ–°æ¶ˆæ¯ä½ç½®ï¼‰
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function loadMoreMessages() {
            messageLoadCount += 12; // æ¯æ¬¡æœ€å¤šåŠ è½½12æ¡
            renderMessages();

            chatMessages.scrollTop = 0;
        }
        
        // æ ¼å¼åŒ–æ¶ˆæ¯æ–‡æœ¬ï¼Œå¤„ç†@æåŠå’ŒURL
        function formatMessageText(text) {
            let formatted = text;
            
            // å¤„ç†@å½“å‰ç”¨æˆ·ï¼ˆè‡ªå·±ï¼‰çš„æåŠ - ç”¨ç»¿è‰²
            formatted = formatted.replace(/@You\s*\(\s*æ‚¨\s*\)/g, '<span class="mention-self">@You (æ‚¨)</span>');
            
            // å¤„ç†@å…¶ä»–ç”¨æˆ·çš„æåŠ - ç”¨æµ…é»„è‰²
            // å…ˆåŒ¹é…å…¨åï¼ˆå¦‚ "Alex Johnson"ï¼‰
            formatted = formatted.replace(/@(\w+\s+\w+)/g, function(match, userName) {
                // æ£€æŸ¥æ˜¯å¦æåˆ°å½“å‰ç”¨æˆ·
                if (userName.includes("You") || userName.includes("æ‚¨")) {
                    return '<span class="mention-self">@' + userName + '</span>';
                }
                return '<span class="mention-other">@' + userName + '</span>';
            });
            
            // å†åŒ¹é…å•åï¼ˆå¦‚ "Alex"ï¼‰
            formatted = formatted.replace(/@(\w+)/g, function(match, userName) {
                // æ£€æŸ¥æ˜¯å¦æåˆ°å½“å‰ç”¨æˆ·
                if (userName === "You") {
                    return '<span class="mention-self">@' + userName + '</span>';
                }
                return '<span class="mention-other">@' + userName + '</span>';
            });
            
            // å¤„ç†URLï¼ˆç®€å•ç‰ˆæœ¬ï¼‰
            formatted = formatted.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank">$1</a>');
            
            return formatted;
        }
        
        // åˆ‡æ¢é¢‘é“
        function switchChannel(channelId) {
            // const targetChannel = channels.find(c => c.id === channelId);
            // if (!targetChannel || !targetChannel.joined) {
            //     alert("ä½ å°šæœªåŠ å…¥è¯¥é¢‘é“ï¼");
            //     return;
            // }
            currentChannelId = channelId;
            messageLoadCount = 12;
            
            // æ›´æ–°é¢‘é“åˆ—è¡¨çš„æ´»è·ƒçŠ¶æ€
            document.querySelectorAll('.channel-item').forEach(item => {
                item.classList.remove('active');
                if (parseInt(item.dataset.channelId) === channelId) {
                    item.classList.add('active');
                }
            });
            
            // æ›´æ–°å½“å‰é¢‘é“ä¿¡æ¯
            const channel = channels.find(c => c.id === channelId);
            currentChannelName.textContent = `# ${channel.name}`;
            currentChannelTopic.textContent = channel.topic;
            
            // é‡ç½®é¢‘é“çš„æœªè¯»æ¶ˆæ¯æ•°
            channel.unread = 0;
            
            // é‡æ–°æ¸²æŸ“æ¶ˆæ¯å’Œå³ä¾§ç”¨æˆ·åˆ—è¡¨
            renderMessages();
            renderChannelUsers();
            renderChannels();
        }
        
        // å¼€å§‹ç§ä¿¡
        function startDirectMessage(userId) {
            const user = users.find(u => u.id === userId);
            alert(`å¼€å§‹ä¸ ${user.name} çš„ç§ä¿¡ï¼ˆæ­¤åŠŸèƒ½ä¸ºæ¼”ç¤ºï¼‰`);
        }
        
        // å‘é€æ¶ˆæ¯
        function sendMessage() {
            const text = chatInput.value.trim();
            if (!text) return;

            // æ£€æŸ¥å½“å‰ç”¨æˆ·æ˜¯å¦åŠ å…¥äº†å½“å‰é¢‘é“
            if (!currentUser.joinedChannels.includes(currentChannelId)) {
                alert("æ‚¨å°šæœªåŠ å…¥è¯¥é¢‘é“ï¼Œæ— æ³•å‘é€æ¶ˆæ¯ï¼");
                return;
            }
            
            // åˆ›å»ºæ–°æ¶ˆæ¯
            const newMessage = {
                id: Date.now(), // ç®€å•IDç”Ÿæˆ
                userId: currentUser.id,
                userName: currentUser.name,
                text: text,
                time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                reactions: []
            };
            
            // æ·»åŠ åˆ°å½“å‰é¢‘é“çš„æ¶ˆæ¯åˆ—è¡¨
            if (!messages[currentChannelId]) {
                messages[currentChannelId] = [];
            }
            messages[currentChannelId].push(newMessage);
            messageLoadCount += 1;
            
            // æ£€æŸ¥æ˜¯å¦æœ‰@æåŠ
            checkMentions(text);
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            chatInput.value = '';
            
            // é‡æ–°æ¸²æŸ“æ¶ˆæ¯
            renderMessages();
            
            // å¦‚æœæœ‰@å…¶ä»–ç”¨æˆ·ï¼Œå¢åŠ é¢‘é“çš„æœªè¯»æ•°
            const mentionedUsers = extractMentionedUsers(text);
            if (mentionedUsers.length > 0) {
                const channel = channels.find(c => c.id === currentChannelId);
                channel.unread++;
                renderChannels();
            }
        }
        
        // æå–æ¶ˆæ¯ä¸­æåˆ°çš„ç”¨æˆ·
        function extractMentionedUsers(text) {
            const mentionedUsers = [];
            const mentionRegex = /@(\w+\s+\w+)|@(\w+)/g;
            let match;
            
            while ((match = mentionRegex.exec(text)) !== null) {
                const mentionedName = match[1] || match[2];
                if (mentionedName && mentionedName !== 'You' && !mentionedName.includes('æ‚¨')) {
                    mentionedUsers.push(mentionedName);
                }
            }
            
            return mentionedUsers;
        }
        
        // æ£€æŸ¥æ¶ˆæ¯ä¸­çš„@æåŠ
        function checkMentions(text) {
            // æ£€æŸ¥æ˜¯å¦@äº†å½“å‰ç”¨æˆ·
            const mentionRegex = /@You\s*\(\s*æ‚¨\s*\)|@You/g;
            if (mentionRegex.test(text)) {
                currentUser.mentions++;
                renderUsers();
            }
        }
        
        // æ˜¾ç¤ºç”¨æˆ·å»ºè®®ï¼ˆå½“è¾“å…¥@æ—¶ï¼‰
        function showUserSuggestions() {
            const cursorPos = chatInput.selectionStart;
            const textBeforeCursor = chatInput.value.substring(0, cursorPos);
            const lastAtPos = textBeforeCursor.lastIndexOf('@');
            
            // å¦‚æœå…‰æ ‡å‰æœ‰@ç¬¦å·
            if (lastAtPos !== -1 && !textBeforeCursor.substring(lastAtPos).includes(' ')) {
                const query = textBeforeCursor.substring(lastAtPos + 1).toLowerCase();
                
                // è¿‡æ»¤åŒ¹é…çš„ç”¨æˆ·ï¼ˆä¸åŒ…æ‹¬è‡ªå·±ï¼‰
                const matchedUsers = users.filter(user => 
                    user.name.toLowerCase().includes(query) && user.id !== currentUser.id
                );
                
                if (matchedUsers.length > 0) {
                    userSuggestions.innerHTML = '';
                    matchedUsers.forEach(user => {
                        const div = document.createElement('div');
                        div.className = 'user-suggestion';
                        div.dataset.userId = user.id;
                        div.dataset.userName = user.name;
                        
                        div.innerHTML = `
                            <div class="user-avatar" style="background-color: ${user.color}; margin-right: 10px;">${user.avatar}</div>
                            <div>${user.name}</div>
                        `;
                        
                        div.addEventListener('click', () => {
                            const beforeAt = chatInput.value.substring(0, lastAtPos + 1);
                            const afterCursor = chatInput.value.substring(cursorPos);
                            chatInput.value = beforeAt + user.name + ' ' + afterCursor;
                            chatInput.focus();
                            chatInput.selectionStart = chatInput.selectionEnd = beforeAt.length + user.name.length + 1;
                            hideUserSuggestions();
                        });
                        
                        userSuggestions.appendChild(div);
                    });
                    
                    userSuggestions.style.display = 'block';
                    return;
                }
            }
            
            // å¦‚æœæ²¡æœ‰åŒ¹é…æˆ–ä¸éœ€è¦æ˜¾ç¤ºï¼Œåˆ™éšè—
            hideUserSuggestions();
        }
        
        // éšè—ç”¨æˆ·å»ºè®®
        function hideUserSuggestions() {
            userSuggestions.style.display = 'none';
        }
        
        // æ˜¾ç¤ºè¡¨æƒ…é€‰æ‹©å™¨
        function showEmojiPicker() {
            if (emojiPicker.style.display === 'grid') {
                emojiPicker.style.display = 'none';
                return;
            }
            
            emojiPicker.innerHTML = '';
            
            // æ·»åŠ å¸¸ç”¨è¡¨æƒ…
            commonEmojis.forEach(emoji => {
                const span = document.createElement('span');
                span.className = 'emoji-item';
                span.textContent = emoji;
                span.addEventListener('click', () => {
                    insertAtCursor(emoji);
                    emojiPicker.style.display = 'none';
                });
                emojiPicker.appendChild(span);
            });
            
            // è®¾ç½®è¡¨æƒ…æ¡†çš„ä½ç½®åœ¨è¡¨æƒ…æŒ‰é’®ä¸‹æ–¹
            const rect = emojiBtn.getBoundingClientRect();
            const containerRect = document.querySelector('.chat-input-container').getBoundingClientRect();
            
            // è®¾ç½®è¡¨æƒ…æ¡†çš„ä½ç½®
            emojiPicker.style.position = 'absolute';
            emojiPicker.style.bottom = `${containerRect.bottom - rect.top}px`;
            emojiPicker.style.right = `${containerRect.right - rect.right}px`;
            
            emojiPicker.style.display = 'grid';
        }
        
        // åœ¨å…‰æ ‡ä½ç½®æ’å…¥æ–‡æœ¬
        function insertAtCursor(text) {
            const start = chatInput.selectionStart;
            const end = chatInput.selectionEnd;
            const before = chatInput.value.substring(0, start);
            const after = chatInput.value.substring(end);
            
            chatInput.value = before + text + after;
            chatInput.focus();
            chatInput.selectionStart = chatInput.selectionEnd = start + text.length;
        }
        
        // åˆ›å»ºæ–°é¢‘é“
        function createNewChannel() {
            const channelName = prompt('è¯·è¾“å…¥æ–°é¢‘é“åç§°:');
            if (!channelName) return;
            
            const channelTopic = prompt('è¯·è¾“å…¥é¢‘é“ä¸»é¢˜:');
            
            const newChannel = {
                id: channels.length + 1,
                name: channelName,
                topic: channelTopic || 'æ–°åˆ›å»ºçš„é¢‘é“',
                unread: 0
            };
            
            channels.push(newChannel);
            messages[newChannel.id] = [];
            
            renderChannels();
            switchChannel(newChannel.id);
        }

        // æ·»åŠ æ–°çš„å‡½æ•°ï¼šæ˜¾ç¤ºè¡¨æƒ…é€‰æ‹©å™¨
function showReactionPicker(messageId, buttonElement) {
    // å…ˆéšè—æ‰€æœ‰å…¶ä»–çš„è¡¨æƒ…é€‰æ‹©å™¨
    document.querySelectorAll('.reaction-picker').forEach(picker => {
        picker.style.display = 'none';
    });
    
    // åˆ›å»ºæˆ–æ˜¾ç¤ºè¡¨æƒ…é€‰æ‹©å™¨
    let picker = document.getElementById(`reaction-picker-${messageId}`);
    
    if (!picker) {
        picker = document.createElement('div');
        picker.className = 'reaction-picker';
        picker.id = `reaction-picker-${messageId}`;
        
        // å¸¸ç”¨è¡¨æƒ…åˆ—è¡¨
        const commonReactions = ["ğŸ‘", "â¤ï¸", "ğŸ˜‚", "ğŸ˜®", "ğŸ˜¢", "ğŸ˜¡", "ğŸ‘", "ğŸ™", "ğŸ”¥", "ğŸ‰", "ğŸš€", "ğŸ’¡", "ğŸ‘€", "âœ…", "âŒ"];
        
        // æ·»åŠ è¡¨æƒ…åˆ°é€‰æ‹©å™¨
        commonReactions.forEach(emoji => {
            const emojiSpan = document.createElement('span');
            emojiSpan.className = 'reaction-emoji';
            emojiSpan.textContent = emoji;
            emojiSpan.dataset.messageId = messageId;
            emojiSpan.dataset.emoji = emoji;
            
            // ç›´æ¥ä¸ºè¡¨æƒ…å…ƒç´ æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
            emojiSpan.addEventListener('click', () => {
                addReaction(messageId, emoji);
                // éšè—è¡¨æƒ…é€‰æ‹©å™¨
                picker.style.display = 'none';
            });
            
            picker.appendChild(emojiSpan);
        });
        
        // å°†é€‰æ‹©å™¨æ·»åŠ åˆ°body
        document.body.appendChild(picker);
    }
    
    // å®šä½é€‰æ‹©å™¨åˆ°æŒ‰é’®æ—è¾¹
    const rect = buttonElement.getBoundingClientRect();
    picker.style.position = 'fixed';
    picker.style.top = `${rect.top - 120}px`;
    picker.style.left = `${rect.left}px`;
    
    // åˆ‡æ¢æ˜¾ç¤º/éšè—
    picker.style.display = picker.style.display === 'grid' ? 'none' : 'grid';
    
    // ç‚¹å‡»å…¶ä»–åœ°æ–¹æ—¶éšè—è¡¨æƒ…é€‰æ‹©å™¨
    const hidePicker = (e) => {
        if (!picker.contains(e.target) && !buttonElement.contains(e.target)) {
            picker.style.display = 'none';
            document.removeEventListener('click', hidePicker);
        }
    };
    
    setTimeout(() => {
        document.addEventListener('click', hidePicker);
    }, 0);
}

// æ·»åŠ æ–°çš„å‡½æ•°ï¼šæ·»åŠ ååº”
function addReaction(messageId, emoji) {
    const channelMsgs = messages[currentChannelId];
    const msg = channelMsgs.find(m => m.id === messageId);
    
    if (!msg) return;
    
    if (!msg.reactions) {
        msg.reactions = [];
    }
    
    const existingReaction = msg.reactions.find(r => r.emoji === emoji);
    
    if (existingReaction) {
        // æ£€æŸ¥å½“å‰ç”¨æˆ·æ˜¯å¦å·²ç»ååº”è¿‡
        if (!existingReaction.users) {
            existingReaction.users = [];
        }
        
        if (!existingReaction.users.includes(currentUser.id)) {
            existingReaction.count++;
            existingReaction.users.push(currentUser.id);
        }
    } else {
        // åˆ›å»ºæ–°çš„ååº”
        msg.reactions.push({
            emoji: emoji,
            count: 1,
            users: [currentUser.id]
        });
    }
    
    renderMessages();
}

function toggleReaction(messageId, emoji) {
    const channelMsgs = messages[currentChannelId];
    const msg = channelMsgs.find(m => m.id === messageId);
    
    if (!msg) return;
    
    if (!msg.reactions) {
        msg.reactions = [];
    }
    
    const existingReaction = msg.reactions.find(r => r.emoji === emoji);
    
    if (existingReaction) {
        // æ£€æŸ¥å½“å‰ç”¨æˆ·æ˜¯å¦å·²ç»ååº”è¿‡
        if (!existingReaction.users) {
            existingReaction.users = [];
        }
        
        const userIndex = existingReaction.users.indexOf(currentUser.id);
        if (userIndex > -1) {
            // ç”¨æˆ·å·²ç»ååº”è¿‡ï¼Œå–æ¶ˆååº”
            existingReaction.count--;
            existingReaction.users.splice(userIndex, 1);
            
            if (existingReaction.count === 0) {
                // å¦‚æœæ²¡æœ‰å…¶ä»–äººååº”äº†ï¼Œç§»é™¤è¿™ä¸ªååº”
                const reactionIndex = msg.reactions.indexOf(existingReaction);
                msg.reactions.splice(reactionIndex, 1);
            }
        } else {
            // ç”¨æˆ·è¿˜æ²¡æœ‰ååº”è¿‡ï¼Œæ·»åŠ ååº”
            existingReaction.count++;
            existingReaction.users.push(currentUser.id);
        }
    } else {
        // åˆ›å»ºæ–°çš„ååº”
        msg.reactions.push({
            emoji: emoji,
            count: 1,
            users: [currentUser.id]
        });
    }
    
    renderMessages();
}
        
        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // å‘é€æ¶ˆæ¯
            sendBtn.addEventListener('click', sendMessage);
            
            // æŒ‰Enterå‘é€æ¶ˆæ¯ï¼ŒShift+Enteræ¢è¡Œ
            chatInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
                
                // å½“è¾“å…¥@æ—¶æ˜¾ç¤ºç”¨æˆ·å»ºè®®
                if (e.key === '@') {
                    setTimeout(showUserSuggestions, 10);
                }
            });
            
            // è¾“å…¥æ—¶æ£€æŸ¥æ˜¯å¦éœ€è¦æ˜¾ç¤ºç”¨æˆ·å»ºè®®
            chatInput.addEventListener('input', showUserSuggestions);
            
            // ç‚¹å‡»å…¶ä»–åœ°æ–¹æ—¶éšè—ç”¨æˆ·å»ºè®®
            document.addEventListener('click', (e) => {
                if (!userSuggestions.contains(e.target) && e.target !== chatInput) {
                    hideUserSuggestions();
                }
            });
            
            // è¡¨æƒ…æŒ‰é’®
            emojiBtn.addEventListener('click', showEmojiPicker);
            
            // ç‚¹å‡»å…¶ä»–åœ°æ–¹æ—¶éšè—è¡¨æƒ…é€‰æ‹©å™¨
            document.addEventListener('click', (e) => {
                if (!emojiPicker.contains(e.target) && !emojiBtn.contains(e.target)) {
                    emojiPicker.style.display = 'none';
                }
            });
            
            // å›¾ç‰‡ä¸Šä¼ æŒ‰é’®
            imageBtn.addEventListener('click', () => {
                alert('å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½ä¸ºæ¼”ç¤ºç”¨é€”');
            });
            
            // æ·»åŠ é¢‘é“æŒ‰é’®
            addChannelBtn.addEventListener('click', createNewChannel);
            
            // æ¶ˆæ¯æ“ä½œï¼ˆååº”ã€å›å¤ï¼‰
            chatMessages.addEventListener('click', (e) => {
                const target = e.target;
                
                // å¤„ç†è¡¨æƒ…æŒ‰é’®
                if (target.classList.contains('react-btn') || target.closest('.react-btn')) {
                    const reactBtn = target.classList.contains('react-btn') ? target : target.closest('.react-btn');
                    const messageId = parseInt(reactBtn.dataset.messageId);
                    showReactionPicker(messageId, reactBtn);
                }
                
                // å¤„ç†è¡¨æƒ…é€‰æ‹©å™¨ä¸­çš„è¡¨æƒ…
                if (target.classList.contains('reaction-emoji')) {
                    const messageId = parseInt(target.dataset.messageId);
                    const emoji = target.dataset.emoji;
                    addReaction(messageId, emoji);
                    // éšè—è¡¨æƒ…é€‰æ‹©å™¨
                    const picker = document.getElementById(`reaction-picker-${messageId}`);
                    if (picker) picker.style.display = 'none';
                }
                
                // å¤„ç†å·²æœ‰çš„è¡¨æƒ…ååº”
                if (target.classList.contains('emoji-reaction')) {
                    const messageId = parseInt(target.dataset.messageId);
                    const emoji = target.dataset.emoji;
                    toggleReaction(messageId, emoji);
                }
                
                // å¤„ç†å›å¤æŒ‰é’®
                if (target.dataset.action === 'reply') {
                    const messageId = parseInt(target.dataset.messageId);
                    const channelMsgs = messages[currentChannelId];
                    const msg = channelMsgs.find(m => m.id === messageId);
                    
                    if (msg) {
                        chatInput.value = `@${msg.userName} `;
                        chatInput.focus();
                    }
                }
            });

            channelList.addEventListener('click', (e) => {
                if (!e.target.classList.contains('channel-action')) return;
                
                const action = e.target.dataset.action;
                const channelId = parseInt(e.target.dataset.channelId);
                const channel = channels.find(c => c.id === channelId);
                
                if (!channel) return;

                if (action === 'join') {
                    channel.joined = true;
                    // æ›´æ–°å½“å‰ç”¨æˆ·çš„joinedChannelså±æ€§
                    currentUser.joinedChannels.push(channelId);
                    // å¯é€‰ï¼šå‘é€ä¸€æ¡ç³»ç»Ÿæ¶ˆæ¯æˆ–æç¤º
                    alert(`å·²åŠ å…¥é¢‘é“ #${channel.name}`);
                } else if (action === 'leave') {
                    if (confirm(`ç¡®å®šè¦é€€å‡ºé¢‘é“ #${channel.name}ï¼Ÿ`)) {
                        channel.joined = false;
                        // æ›´æ–°å½“å‰ç”¨æˆ·çš„joinedChannelså±æ€§
                        currentUser.joinedChannels = currentUser.joinedChannels.filter(id => id !== channelId);
                        // ç§»é™¤è‡ªåŠ¨åˆ‡æ¢é¢‘é“çš„é€»è¾‘ï¼Œè®©ç”¨æˆ·ä¿æŒåœ¨å½“å‰é¢‘é“
                        /*
                        if (currentChannelId === channelId) {
                            const firstJoined = channels.find(c => c.joined);
                            if (firstJoined) {
                                switchChannel(firstJoined.id);
                            }
                        }
                        */
                    }
                }

                renderChannels();
                renderChannelUsers(); // ç¡®ä¿é€€å‡ºé¢‘é“åé‡æ–°æ¸²æŸ“é¢‘é“ç”¨æˆ·åˆ—è¡¨
            });
        }
        
        // åˆå§‹åŒ–åº”ç”¨
        initApp();
    </script>
</body>
</html>